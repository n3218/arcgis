(this["webpackJsonpfirst-example"]=this["webpackJsonpfirst-example"]||[]).push([[7,85],{1002:function(e,t,r){"use strict";r.d(t,"a",(function(){return b}));var i=r(15),n=r(2),a=r(3),o=(r(14),r(4)),s=r(104),c=r(11),u=r(22),l=r(137),h=function e(){Object(n.a)(this,e),this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2},d=r(897),f=r(845),p=r(218),v=1e-5,b=function(){function e(t){Object(n.a)(this,e),this.options=new h,this.results=new d.b,this.transform=new f.a,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=v,this.verticalOffset=null,this._ray={origin:Object(u.e)(),direction:Object(u.e)()},this._rayEndPoint=Object(u.e)(),this._rayStartPointTransformed=Object(u.e)(),this._rayEndPointTransformed=Object(u.e)(),this.viewingMode=null==t?1:t}return Object(a.a)(e,[{key:"ray",get:function(){return this._ray}},{key:"rayBeginPoint",get:function(){return this._ray.origin}},{key:"rayEndPoint",get:function(){return this._rayEndPoint}},{key:"reset",value:function(e,t){this.resetWithRay(Object(l.e)(e,t,this._ray))}},{key:"resetWithRay",value:function(e){e!==this._ray&&Object(l.b)(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(c.f)(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}},{key:"intersect",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,c=arguments.length>5?arguments[5]:void 0;this.point=r,this.camera=n,this.filterPredicate=s,this.tolerance=null==a?v:a;var u=Object(f.c)(this.verticalOffset);Object(o.k)(t)&&t.length>0&&function(){var r,n=c?function(t){c(t)&&e.intersectObject(t)}:function(t){e.intersectObject(t)},a=Object(i.a)(t);try{for(a.s();!(r=a.n()).done;){var s=r.value,l=s.getSpatialQueryAccelerator&&s.getSpatialQueryAccelerator();Object(o.k)(l)?(Object(o.k)(u)?l.forEachAlongRayWithVerticalOffset(e._ray.origin,e._ray.direction,n,u):l.forEachAlongRay(e._ray.origin,e._ray.direction,n),e.options.selectionMode&&e.options.hud&&l.forEachDegenerateObject(n)):s.objects.forAll((function(e){return n(e)}))}}catch(h){a.e(h)}finally{a.f()}}(),this.sortResults()}},{key:"intersectObject",value:function(e){var t=this;this._numObjectsTested++;var r=e.geometryRecords;if(r){var n,a,u=e.id,l=e.transformation,h=Object(f.c)(this.verticalOffset),v=Object(i.a)(r);try{var b=function(){var r=a.value,i=r.geometry,f=r.material,v=r.instanceParameters;if(Object(p.e)(v))return"continue";n=i.id,t.transform.setAndInvalidateLazyTransforms(l,r.getShaderTransformation()),Object(c.q)(t._rayStartPointTransformed,t._ray.origin,t.transform.inverse),Object(c.q)(t._rayEndPointTransformed,t._rayEndPoint,t.transform.inverse);var b=t.transform.transform;Object(o.k)(h)&&(h.objectTransform=t.transform),f.intersect(i,v,t.transform.transform,t,t._rayStartPointTransformed,t._rayEndPointTransformed,(function(r,i,a,c,l,h){if(r>=0){if(Object(o.k)(t.filterPredicate)&&!t.filterPredicate(t._ray.origin,t._rayEndPoint,r))return;var f="Object3D ".concat(u);if(l)return void((null==t.results.hud.dist||r<t.results.hud.dist)&&t.results.hud.set(e,f,r,i,s.a,c,h,n,a));var p=function(t){return t.set(e,f,r,i,b,c,null,n,a)};if((null==t.results.min.drapedLayerOrder||c>=t.results.min.drapedLayerOrder)&&(null==t.results.min.dist||r<t.results.min.dist)&&p(t.results.min),0!==t.options.store&&(null==t.results.max.drapedLayerOrder||c<t.results.max.drapedLayerOrder)&&(null==t.results.max.dist||r>t.results.max.dist)&&p(t.results.max),2===t.options.store){var v=new d.a(t._ray);p(v),t.results.all.push(v)}}}),r.shaderTransformation)};for(v.s();!(a=v.n()).done;)b()}catch(g){v.e(g)}finally{v.f()}}}},{key:"sortResults",value:function(){this.results.all.sort((function(e,t){return e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)}))}}]),e}();b.DEFAULT_TOLERANCE=v},1007:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return l}));var i,n,a=r(29),o=r(233),s=r(27);function c(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(Object(s.a)(i||(i=Object(a.a)(["vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n{\nvec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\nvec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\nreprojectedCoord.xy /= reprojectedCoord.w;\nreturn reprojectedCoord.xy * 0.5 + 0.5;\n}"]))))}function u(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(o.a),e.include(c),e.fragment.code.add(Object(s.a)(n||(n=Object(a.a)(["\n  const int maxSteps = ","\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n          return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150;":"75;"))}function l(e,t){var r,i;t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),i=t,(r=e).bindTexture(i.lastFrameColorTexture,"lastFrameColorMap"),r.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),r.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix))}},1008:function(e,t,r){"use strict";r.d(t,"a",(function(){return p}));var i,n=r(29),a=r(952),o=r(27);function s(e){e.fragment.code.add(Object(o.a)(i||(i=Object(n.a)(["const float GAMMA = 2.2;\nconst float INV_GAMMA = 0.4545454545;\nvec4 delinearizeGamma(vec4 color) {\nreturn vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n}\nvec3 linearizeGamma(vec3 color) {\nreturn pow(color, vec3(GAMMA));\n}"]))))}var c,u,l,h,d=r(784),f=r(1007);function p(e,t){e.include(d.a,t),e.include(s),e.include(a.a),t.ssrEnabled&&e.include(f.a,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(Object(o.a)(c||(c=Object(n.a)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),e.fragment.code.add(Object(o.a)(u||(u=Object(n.a)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {\nfloat reflectionHit = 0.;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nspecular = shadingInfo.NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}"])))),t.ssrEnabled?e.fragment.code.add(Object(o.a)(l||(l=Object(n.a)(["vec4 viewPosition = vec4(positionView.xyz, 1.0);\nvec3 viewDir = normalize(viewPosition.xyz);\nvec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = ssrViewMat *vec4(localUp, 0.0);\nfloat correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);\nvec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));\nvec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);\nreflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\nreflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;\n}\nfloat seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);\nreturn tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);\n}"])))):e.fragment.code.add(Object(o.a)(h||(h=Object(n.a)(["return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);\n}"]))))}},708:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var i,n,a={exports:{}};i=a,void 0!==(n=function(){function e(e,r,n){n=n||2;var a,o,s,u,l,h,d,f=r&&r.length,p=f?r[0]*n:e.length,v=t(e,0,p,n,!0),b=[];if(!v||v.next===v.prev)return b;if(f&&(v=c(e,r,v,n)),e.length>80*n){a=s=e[0],o=u=e[1];for(var g=n;g<p;g+=n)(l=e[g])<a&&(a=l),(h=e[g+1])<o&&(o=h),l>s&&(s=l),h>u&&(u=h);d=0!==(d=Math.max(s-a,u-o))?1/d:0}return i(v,b,n,a,o,d),b}function t(e,t,r,i,n){var a,o;if(n===R(e,t,r,i)>0)for(a=t;a<r;a+=i)o=w(a,e[a],e[a+1],o);else for(a=r-i;a>=t;a-=i)o=w(a,e[a],e[a+1],o);return o&&m(o,o.next)&&(T(o),o=o.next),o}function r(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!m(i,i.next)&&0!==g(i.prev,i,i.next))i=i.next;else{if(T(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}function i(e,t,c,u,l,h,f){if(e){!f&&h&&d(e,u,l,h);for(var p,v,b=e;e.prev!==e.next;)if(p=e.prev,v=e.next,h?a(e,u,l,h):n(e))t.push(p.i/c),t.push(e.i/c),t.push(v.i/c),T(e),e=v.next,b=v.next;else if((e=v)===b){f?1===f?i(e=o(r(e),t,c),t,c,u,l,h,2):2===f&&s(e,t,c,u,l,h):i(r(e),t,c,u,l,h,1);break}}}function n(e){var t=e.prev,r=e,i=e.next;if(g(t,r,i)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(v(t.x,t.y,r.x,r.y,i.x,i.y,n.x,n.y)&&g(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function a(e,t,r,i){var n=e.prev,a=e,o=e.next;if(g(n,a,o)>=0)return!1;for(var s=n.x<a.x?n.x<o.x?n.x:o.x:a.x<o.x?a.x:o.x,c=n.y<a.y?n.y<o.y?n.y:o.y:a.y<o.y?a.y:o.y,u=n.x>a.x?n.x>o.x?n.x:o.x:a.x>o.x?a.x:o.x,l=n.y>a.y?n.y>o.y?n.y:o.y:a.y>o.y?a.y:o.y,h=f(s,c,t,r,i),d=f(u,l,t,r,i),p=e.prevZ,b=e.nextZ;p&&p.z>=h&&b&&b.z<=d;){if(p!==e.prev&&p!==e.next&&v(n.x,n.y,a.x,a.y,o.x,o.y,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,b!==e.prev&&b!==e.next&&v(n.x,n.y,a.x,a.y,o.x,o.y,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&v(n.x,n.y,a.x,a.y,o.x,o.y,p.x,p.y)&&g(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;b&&b.z<=d;){if(b!==e.prev&&b!==e.next&&v(n.x,n.y,a.x,a.y,o.x,o.y,b.x,b.y)&&g(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function o(e,t,i){var n=e;do{var a=n.prev,o=n.next.next;!m(a,o)&&y(a,n,n.next,o)&&_(a,o)&&_(o,a)&&(t.push(a.i/i),t.push(n.i/i),t.push(o.i/i),T(n),T(n.next),n=e=o),n=n.next}while(n!==e);return r(n)}function s(e,t,n,a,o,s){var c=e;do{for(var u=c.next.next;u!==c.prev;){if(c.i!==u.i&&b(c,u)){var l=x(c,u);return c=r(c,c.next),l=r(l,l.next),i(c,t,n,a,o,s),void i(l,t,n,a,o,s)}u=u.next}c=c.next}while(c!==e)}function c(e,i,n,a){var o,s,c,h=[];for(o=0,s=i.length;o<s;o++)(c=t(e,i[o]*a,o<s-1?i[o+1]*a:e.length,a,!1))===c.next&&(c.steiner=!0),h.push(p(c));for(h.sort(u),o=0;o<h.length;o++)n=r(n=l(h[o],n),n.next);return n}function u(e,t){return e.x-t.x}function l(e,t){var i=function(e,t){var r,i=t,n=e.x,a=e.y,o=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var s=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>o){if(o=s,s===n){if(a===i.y)return i;if(a===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(n===o)return r;var c,u=r,l=r.x,d=r.y,f=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&v(a<d?n:o,a,l,d,a<d?o:n,a,i.x,i.y)&&(c=Math.abs(a-i.y)/(n-i.x),_(i,e)&&(c<f||c===f&&(i.x>r.x||i.x===r.x&&h(r,i)))&&(r=i,f=c)),i=i.next}while(i!==u);return r}(e,t);if(!i)return t;var n=x(i,e),a=r(i,i.next);return r(n,n.next),t===i?a:t}function h(e,t){return g(e.prev,e,t.prev)<0&&g(t.next,e,e.next)<0}function d(e,t,r,i){var n=e;do{if(null===n.z&&(n.z=f(n.x,n.y,t,r,i)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,d(e,t,r,i);n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,r,i,n,a,o,s,c,u=1;do{for(r=e,e=null,a=null,o=0;r;){for(o++,i=r,s=0,t=0;t<u&&(s++,i=i.nextZ);t++);for(c=u;s>0||c>0&&i;)0!==s&&(0===c||!i||r.z<=i.z)?(n=r,r=r.nextZ,s--):(n=i,i=i.nextZ,c--),a?a.nextZ=n:e=n,n.prevZ=a,a=n;r=i}a.nextZ=null,u*=2}while(o>1)}(n)}function f(e,t,r,i,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function p(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function v(e,t,r,i,n,a,o,s){return(n-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(i-s)-(r-o)*(t-s)>=0&&(r-o)*(a-s)-(n-o)*(i-s)>=0}function b(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&y(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(_(e,t)&&_(t,e)&&function(e,t){var r=e,i=!1,n=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&r.next.y!==r.y&&n<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(g(e.prev,e,t.prev)||g(e,t.prev,t))||m(e,t)&&g(e.prev,e,e.next)>0&&g(t.prev,t,t.next)>0)}function g(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function m(e,t){return e.x===t.x&&e.y===t.y}function y(e,t,r,i){var n=j(g(e,t,r)),a=j(g(e,t,i)),o=j(g(r,i,e)),s=j(g(r,i,t));return n!==a&&o!==s||!(0!==n||!O(e,r,t))||!(0!==a||!O(e,i,t))||!(0!==o||!O(r,e,i))||!(0!==s||!O(r,t,i))}function O(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function j(e){return e>0?1:e<0?-1:0}function _(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function x(e,t){var r=new S(e.i,e.x,e.y),i=new S(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=n,n.prev=r,i.next=r,r.prev=i,a.next=i,i.prev=a,i}function w(e,t,r,i){var n=new S(e,t,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function T(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function S(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(e,t,r,i){for(var n=0,a=t,o=r-i;a<r;a+=i)n+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return n}return e.deviation=function(e,t,r,i){var n=t&&t.length,a=n?t[0]*r:e.length,o=Math.abs(R(e,0,a,r));if(n)for(var s=0,c=t.length;s<c;s++){var u=t[s]*r,l=s<c-1?t[s+1]*r:e.length;o-=Math.abs(R(e,u,l,r))}var h=0;for(s=0;s<i.length;s+=3){var d=i[s]*r,f=i[s+1]*r,p=i[s+2]*r;h+=Math.abs((e[d]-e[p])*(e[f+1]-e[d+1])-(e[d]-e[f])*(e[p+1]-e[d+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,n=0;n<e.length;n++){for(var a=0;a<e[n].length;a++)for(var o=0;o<t;o++)r.vertices.push(e[n][a][o]);n>0&&(i+=e[n-1].length,r.holes.push(i))}return r},e}())&&(i.exports=n);var o=a.exports},744:function(e,t,r){"use strict";r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return c})),r.d(t,"c",(function(){return l})),r.d(t,"d",(function(){return u}));var i,n=r(29),a=r(295),o=r(27);function s(e){e.fragment.include(a.a),e.fragment.uniforms.add("uShadowMapTex","sampler2D"),e.fragment.uniforms.add("uShadowMapNum","int"),e.fragment.uniforms.add("uShadowMapDistance","vec4"),e.fragment.uniforms.add("uShadowMapMatrix","mat4",4),e.fragment.uniforms.add("uDepthHalfPixelSz","float"),e.fragment.code.add(Object(o.a)(i||(i=Object(n.a)(["int chooseCascade(float _linearDepth, out mat4 mat) {\nvec4 distance = uShadowMapDistance;\nfloat depth = _linearDepth;\nint i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\nmat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];\nreturn i;\n}\nvec3 lightSpacePosition(vec3 _vpos, mat4 mat) {\nvec4 lv = mat * vec4(_vpos, 1.0);\nlv.xy /= lv.w;\nreturn 0.5 * lv.xyz + vec3(0.5);\n}\nvec2 cascadeCoordinates(int i, vec3 lvpos) {\nreturn vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n}\nfloat readShadowMapDepth(vec2 uv, sampler2D _depthTex) {\nreturn rgba2float(texture2D(_depthTex, uv));\n}\nfloat posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {\nreturn readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;\n}\nfloat filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {\nfloat texSize = 0.5 / halfPixelSize;\nvec2 st = fract((vec2(halfPixelSize) + uv) * texSize);\nfloat s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);\nfloat s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);\nfloat s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);\nfloat s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);\nreturn mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n}\nfloat readShadowMap(const in vec3 _vpos, float _linearDepth) {\nmat4 mat;\nint i = chooseCascade(_linearDepth, mat);\nif (i >= uShadowMapNum) { return 0.0; }\nvec3 lvpos = lightSpacePosition(_vpos, mat);\nif (lvpos.z >= 1.0) { return 0.0; }\nif (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\nvec2 uv = cascadeCoordinates(i, lvpos);\nreturn filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);\n}"]))))}function c(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function u(e,t,r){t.shadowMappingEnabled&&t.shadowMap.bindView(e,r)}function l(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},764:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));var i,n,a,o=r(29),s=r(27);function c(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(Object(s.a)(i||(i=Object(o.a)(["void forwardLinearDepth() { linearDepth = gl_Position.w; }"]))))):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add(Object(s.a)(n||(n=Object(o.a)(["void forwardLinearDepth() {\nlinearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);\n}"]))))):e.vertex.code.add(Object(s.a)(a||(a=Object(o.a)(["void forwardLinearDepth() {}"]))))}},784:function(e,t,r){"use strict";r.d(t,"a",(function(){return j}));var i,n,a,o=r(29),s=r(27);function c(e){var t=e.fragment.code;t.add(Object(s.a)(i||(i=Object(o.a)(["vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n{\nreturn ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n}"])))),t.add(Object(s.a)(n||(n=Object(o.a)(["float integratedRadiance(float cosTheta2, float roughness)\n{\nreturn (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n}"])))),t.add(Object(s.a)(a||(a=Object(o.a)(["vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n{\nfloat cosTheta2 = 1.0 - RdotNG * RdotNG;\nfloat intRadTheta = integratedRadiance(cosTheta2, roughness);\nfloat ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\nfloat sky = 2.0 - ground;\nreturn (ground * ambientGround + sky * ambientSky) * 0.5;\n}"]))))}var u,l,h,d,f,p,v,b,g,m,y,O=r(543);function j(e,t){var r=e.fragment.code;e.include(O.a),3===t.pbrMode||4===t.pbrMode?(r.add(Object(s.a)(u||(u=Object(o.a)(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),r.add(Object(s.a)(l||(l=Object(o.a)(["vec3 fresnelReflection(float angle, vec3 f0, float f90) {\nreturn f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n}"])))),r.add(Object(s.a)(h||(h=Object(o.a)(["float normalDistributionWater(float NdotH, float roughness)\n{\nfloat r2 = roughness * roughness;\nfloat NdotH2 = NdotH * NdotH;\nfloat denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\nreturn r2 / denom;\n}"])))),r.add(Object(s.a)(d||(d=Object(o.a)(["float geometricOcclusionKelemen(float LoH)\n{\nreturn 0.25 / (LoH * LoH);\n}"])))),r.add(Object(s.a)(f||(f=Object(o.a)(["vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n{\nvec3  F = fresnelReflection(props.VdotH, F0, F0Max);\nfloat dSun = normalDistributionWater(props.NdotH, roughness);\nfloat V = geometricOcclusionKelemen(props.LdotH);\nfloat diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\nfloat strengthSunHaze  = 1.2;\nfloat dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\nreturn ((dSun + dSunHaze) * V) * F;\n}\nvec3 tonemapACES(const vec3 x) {\nreturn (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n}"]))))):1!==t.pbrMode&&2!==t.pbrMode||(e.include(c),r.add(Object(s.a)(p||(p=Object(o.a)(["struct PBRShadingInfo\n{\nfloat NdotL;\nfloat NdotV;\nfloat NdotH;\nfloat VdotH;\nfloat LdotH;\nfloat NdotNG;\nfloat RdotNG;\nfloat NdotAmbDir;\nfloat NdotH_Horizon;\nvec3 skyRadianceToSurface;\nvec3 groundRadianceToSurface;\nvec3 skyIrradianceToSurface;\nvec3 groundIrradianceToSurface;\nfloat averageAmbientRadiance;\nfloat ssao;\nvec3 albedoLinear;\nvec3 f0;\nvec3 f90;\nvec3 diffuseColor;\nfloat metalness;\nfloat roughness;\n};"])))),r.add(Object(s.a)(v||(v=Object(o.a)(["float normalDistribution(float NdotH, float roughness)\n{\nfloat a = NdotH * roughness;\nfloat b = roughness / (1.0 - NdotH * NdotH + a * a);\nreturn b * b * INV_PI;\n}"])))),r.add(Object(s.a)(b||(b=Object(o.a)(["const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\nconst vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\nconst vec2 c2 = vec2(-1.04, 1.04);\nvec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\nreturn c2 * a004 + r.zw;\n}"])))),r.add(Object(s.a)(g||(g=Object(o.a)(["vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\nvec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\nvec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\nvec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\nvec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\nvec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\nvec3 specularComponent = specularColor * indirectSpecular;\nreturn (diffuseComponent + specularComponent);\n}"])))),r.add(Object(s.a)(m||(m=Object(o.a)(["float gamutMapChanel(float x, vec2 p){\nreturn (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n}"])))),r.add(Object(s.a)(y||(y=Object(o.a)(["vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\nvec3 outColor;\nvec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\noutColor.x = gamutMapChanel(inColor.x, p) ;\noutColor.y = gamutMapChanel(inColor.y, p) ;\noutColor.z = gamutMapChanel(inColor.z, p) ;\nreturn outColor;\n}"])))))}},796:function(e,t,r){"use strict";var i=r(2),n=r(5),a=r(6),o=r(0),s=r(34),c=r(1),u=(r(14),r(16),r(13),r(8)),l=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,e.SCENEVIEW_LOCKING_LOG=!1,e.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,e.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,e.DECONFLICTOR_SHOW_VISIBLE=!1,e.DECONFLICTOR_SHOW_INVISIBLE=!1,e.DECONFLICTOR_SHOW_GRID=!1,e.LABELS_SHOW_BORDER=!1,e.OVERLAY_DRAW_DEBUG_TEXTURE=!1,e.OVERLAY_SHOW_CENTER=!1,e.SHOW_POI=!1,e.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,e.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,e.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,e.DRAW_MESH_GEOMETRY_NORMALS=!1,e.FEATURE_TILE_FETCH_SHOW_TILES=!1,e.FEATURE_TILE_TREE_SHOW_TILES=!1,e.TERRAIN_TILE_TREE_SHOW_TILES=!1,e.I3S_TREE_SHOW_TILES=!1,e.I3S_SHOW_MODIFICATIONS=!1,e.ENABLE_PROFILE_DEPTH_RANGE=!1,e.DISABLE_FAST_UPDATES=!1,e.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,e.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,e.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,e}return r}(s.a);Object(o.a)([Object(c.b)()],l.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(o.a)([Object(c.b)()],l.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(o.a)([Object(c.b)()],l.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(o.a)([Object(c.b)()],l.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(o.a)([Object(c.b)()],l.prototype,"LABELS_SHOW_BORDER",void 0),Object(o.a)([Object(c.b)()],l.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(o.a)([Object(c.b)()],l.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(o.a)([Object(c.b)()],l.prototype,"SHOW_POI",void 0),Object(o.a)([Object(c.b)()],l.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(o.a)([Object(c.b)()],l.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(o.a)([Object(c.b)()],l.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(o.a)([Object(c.b)()],l.prototype,"DISABLE_FAST_UPDATES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(o.a)([Object(c.b)()],l.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(o.a)([Object(c.b)()],l.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0);var h=new(l=Object(o.a)([Object(u.a)("esri.views.3d.support.DebugFlags")],l));t.a=h},797:function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return y})),r.d(t,"c",(function(){return E})),r.d(t,"d",(function(){return O})),r.d(t,"e",(function(){return x})),r.d(t,"f",(function(){return C})),r.d(t,"g",(function(){return w})),r.d(t,"h",(function(){return I})),r.d(t,"i",(function(){return P})),r.d(t,"j",(function(){return j}));var i=r(15),n=r(2),a=(r(14),r(13)),o=r(40),s=r(220),c=r(78),u=r(104),l=r(11),h=r(22),d=r(86),f=r(59),p=r(137),v=r(348),b=r(67),g=a.a.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function m(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:V;return{plane:Object(f.d)(e.plane),origin:Object(h.c)(e.origin),basis1:Object(h.c)(e.basis1),basis2:Object(h.c)(e.basis2)}}function y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m();return O(e.origin,e.basis1,e.basis2,t)}function O(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:m();return Object(l.k)(i.origin,e),Object(l.k)(i.basis1,t),Object(l.k)(i.basis2,r),j(i),H(i,"fromValues()"),i}function j(e){Object(f.i)(e.basis2,e.basis1,e.origin,e.plane)}function _(e,t,r){e!==r&&y(e,r);var i=Object(l.e)(b.d.get(),I(e),t);return Object(l.f)(r.origin,r.origin,i),r.plane[3]-=t,r}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:m(),r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return Object(l.w)(t.origin,e[0]+r,e[1]+i,0),Object(l.w)(t.basis1,r,0,0),Object(l.w)(t.basis2,0,i,0),Object(f.h)(0,0,1,0,t.plane),t}function w(e,t,r){return!!Object(f.m)(e.plane,t,r)&&A(e,r)}function T(e,t,r){var n=F.get();N(e,t,n,F.get());var a,s=Number.POSITIVE_INFINITY,c=Object(i.a)(B);try{for(c.s();!(a=c.n()).done;){var u=z(e,a.value,G.get()),h=b.d.get();if(Object(f.k)(n,u,h)){var d=Object(l.v)(b.d.get(),t.origin,h),p=Math.abs(Object(o.b)(Object(l.h)(t.direction,d)));p<s&&(s=p,Object(l.k)(r,h))}}}catch(v){c.e(v)}finally{c.f()}return s===Number.POSITIVE_INFINITY?S(e,t,r):r}function S(e,t,r){if(w(e,t,r))return r;var n=F.get(),a=F.get();N(e,t,n,a);var o,s=Number.POSITIVE_INFINITY,c=Object(i.a)(B);try{for(c.s();!(o=c.n()).done;){var u=z(e,o.value,G.get()),h=b.d.get();if(Object(f.l)(n,u,h)){var d=Object(p.d)(t,h);if(!Object(f.o)(a,h))continue;d<s&&(s=d,Object(l.k)(r,h))}}}catch(v){c.e(v)}finally{c.f()}return M(e,t.origin)<s&&R(e,t.origin,r),r}function R(e,t,r){var i=Object(f.s)(e.plane,t,b.d.get()),n=Object(d.i)(L(e,e.basis1),i,-1,1,b.d.get()),a=Object(d.i)(L(e,e.basis2),i,-1,1,b.d.get());return Object(l.j)(r,Object(l.f)(b.d.get(),n,a),e.origin),r}function k(e,t,r){var i=e.origin,n=e.basis1,a=e.basis2,o=Object(l.j)(b.d.get(),t,i),s=Object(v.d)(n,o),c=Object(v.d)(a,o),u=Object(v.d)(I(e),o);return Object(l.w)(r,s,c,u)}function M(e,t){var r=k(e,t,b.d.get()),i=e.basis1,n=e.basis2,a=Object(l.p)(i),o=Object(l.p)(n),s=Math.max(Math.abs(r[0])-a,0),c=Math.max(Math.abs(r[1])-o,0),u=r[2];return s*s+c*c+u*u}function C(e,t){return Math.sqrt(M(e,t))}function E(e,t){return Object(f.o)(e.plane,t)&&A(e,t)}function D(e,t){var r=-e.plane[3];return Object(v.d)(I(e),t)-r}function P(e,t,r,i){return e!==i&&y(e,i),Object(c.c)(Z,Object(c.i)(Z),t,r),Object(l.q)(i.basis1,e.basis1,Z),Object(l.q)(i.basis2,e.basis2,Z),j(i),i}function I(e){return Object(f.r)(e.plane)}function A(e,t){var r=Object(l.j)(b.d.get(),t,e.origin),i=Object(l.t)(e.basis1),n=Object(l.t)(e.basis2),a=Object(l.h)(e.basis1,r),o=Object(l.h)(e.basis2,r);return-a-i<0&&a-i<0&&-o-n<0&&o-n<0}function L(e,t){var r=G.get();return Object(l.k)(r.origin,e.origin),Object(l.k)(r.vector,t),r}function z(e,t,r){var i=e.basis1,n=e.basis2,a=e.origin,o=Object(l.e)(b.d.get(),i,t.origin[0]),s=Object(l.e)(b.d.get(),n,t.origin[1]);Object(l.f)(r.origin,o,s),Object(l.f)(r.origin,r.origin,a);var c=Object(l.e)(b.d.get(),i,t.direction[0]),u=Object(l.e)(b.d.get(),n,t.direction[1]);return Object(l.e)(r.vector,Object(l.f)(c,c,u),2),r}function H(e,t){Math.abs(Object(l.h)(e.basis1,e.basis2)/(Object(l.p)(e.basis1)*Object(l.p)(e.basis2)))>1e-6&&g.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(Object(l.h)(e.basis1,I(e)))>1e-6&&g.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-Object(l.h)(I(e),e.origin)-e.plane[3])>1e-6&&g.warn(t,"Plane offset is not consistent with plane origin")}function N(e,t,r,i){var n=I(e);Object(f.i)(n,t.direction,t.origin,r),Object(f.i)(Object(f.r)(r),n,t.origin,i)}var V={plane:Object(f.d)(),origin:Object(h.g)(0,0,0),basis1:Object(h.g)(1,0,0),basis2:Object(h.g)(0,1,0)},F=new s.a(f.d),G=new s.a(d.d),U=Object(h.e)(),W=new s.a((function(){return{origin:null,basis1:null,basis2:null,plane:null}})),B=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],q=Object(u.d)(),Z=Object(u.d)();Object.freeze({__proto__:null,BoundedPlaneClass:function e(){Object(n.a)(this,e),this.plane=Object(f.d)(),this.origin=Object(h.e)(),this.basis1=Object(h.e)(),this.basis2=Object(h.e)()},create:m,wrap:function(e,t,r){var i=W.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=Object(f.v)(0,0,0,0),j(i),i},copy:y,copyWithoutVerify:function(e,t){Object(l.k)(t.origin,e.origin),Object(l.k)(t.basis1,e.basis1),Object(l.k)(t.basis2,e.basis2),Object(f.c)(e.plane,t.plane)},fromValues:O,updateUnboundedPlane:j,elevate:_,setExtent:function(e,t,r){return x(t,r),_(r,D(e,e.origin),r),r},fromAABoundingRect:x,intersectRay:w,intersectRayClosestSilhouette:function(e,t,r){if(w(e,t,r))return r;var i=T(e,t,b.d.get());return Object(l.f)(r,t.origin,Object(l.e)(b.d.get(),t.direction,Object(l.m)(t.origin,i)/Object(l.p)(t.direction))),r},closestPointOnSilhouette:T,closestPoint:S,projectPoint:R,projectPointLocal:k,distance2:M,distance:C,distanceToSilhouette:function(e,t){var r,n=Number.NEGATIVE_INFINITY,a=Object(i.a)(B);try{for(a.s();!(r=a.n()).done;){var o=z(e,r.value,G.get()),s=Object(d.e)(o,t);s>n&&(n=s)}}catch(c){a.e(c)}finally{a.f()}return Math.sqrt(n)},extrusionContainsPoint:E,axisAt:function(e,t,r,i){return function(e,t,r){switch(t){case 0:Object(l.k)(r,e.basis1),Object(l.r)(r,r);break;case 1:Object(l.k)(r,e.basis2),Object(l.r)(r,r);break;case 2:Object(l.k)(r,I(e))}return r}(e,r,i)},altitudeAt:D,setAltitudeAt:function(e,t,r,i){var n=D(e,t),a=Object(l.e)(U,I(e),r-n);return Object(l.f)(i,t,a),i},equals:function(e,t){return Object(l.o)(e.basis1,t.basis1)&&Object(l.o)(e.basis2,t.basis2)&&Object(l.o)(e.origin,t.origin)},transform:function(e,t,r){return e!==r&&y(e,r),Object(c.a)(q,t),Object(c.e)(q,q),Object(l.q)(r.basis1,e.basis1,q),Object(l.q)(r.basis2,e.basis2,q),Object(l.q)(Object(f.r)(r.plane),Object(f.r)(e.plane),q),Object(l.q)(r.origin,e.origin,t),Object(f.t)(r.plane,r.origin,r.plane),r},rotate:P,normal:I,UP:V})},814:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var i=r(40);function n(e,t,r){var n,u=e.byteLength/(4*t),l=new Uint32Array(e,0,u*t),h=new Uint32Array(u),d=null!=(n=null==r?void 0:r.minReduction)?n:0,f=(null==r?void 0:r.originalIndices)||null,p=f?f.length:0,v=(null==r?void 0:r.componentOffsets)||null,b=0;if(v)for(var g=0;g<v.length-1;g++){var m=v[g+1]-v[g];m>b&&(b=m)}else b=u;var y=Math.floor(1.1*b)+1;(null==c||c.length<2*y)&&(c=new Uint32Array(Object(i.o)(2*y)));for(var O=0;O<2*y;O++)c[O]=0;for(var j=0,_=!!v&&!!f,x=_?p:u,w=_?new Uint32Array(p):null,T=1.96,S=0!==d?Math.ceil(4*T*T/(d*d)*d*(1-d)):x,R=1,k=v?v[1]:x,M=0;M<x;M++){if(M===S){var C=1-j/M;if(C+T*Math.sqrt(C*(1-C)/M)<d)return null;S*=2}if(M===k){for(var E=0;E<2*y;E++)c[E]=0;if(f)for(var D=v[R-1];D<v[R];D++)w[D]=h[f[D]];k=v[++R]}for(var P=_?f[M]:M,I=P*t,A=s(l,I,t),L=A%y,z=j;0!==c[2*L+1];){if(c[2*L]===A){var H=c[2*L+1]-1;if(a(l,I,H*t,t)){z=h[H];break}}++L>=y&&(L-=y)}z===j&&(c[2*L]=A,c[2*L+1]=P+1,j++),h[P]=z}if(0!==d&&1-j/u<d)return null;if(_){for(var N=v[R-1];N<w.length;N++)w[N]=h[f[N]];h=w}var V=new Uint32Array(t*j);j=0;for(var F=0;F<x;F++)h[F]===j&&(o(l,(_?f[F]:F)*t,V,j*t,t),j++);if(f&&!_){for(var G=new Uint32Array(p),U=0;U<G.length;U++)G[U]=h[f[U]];h=G}return{buffer:V.buffer,indices:h,uniqueCount:j}}function a(e,t,r,i){for(var n=0;n<i;n++)if(e[t+n]!==e[r+n])return!1;return!0}function o(e,t,r,i,n){for(var a=0;a<n;a++)r[i+a]=e[t+a]}function s(e,t,r){for(var i=0,n=0;n<r;n++)i=(i=e[t+n]+i|0)+(i<<11)+(i>>>2)|0;return i>>>0}var c=null},822:function(e,t,r){"use strict";var i=r(2),n=r(3),a=r(13),o=r(40),s=r(4),c=r(32),u=r(78),l=r(104),h=r(26),d=r(47),f=r(11),p=r(22),v=r(77),b=r(85),g=r(281),m=r(137),y=r(348),O=r(75),j=a.a.getLogger("esri.views.3d.webgl-engine.lib.Camera"),_=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;Object(i.a)(this,e),this._viewUp=Object(p.e)(),this._viewForward=Object(p.e)(),this._viewRight=Object(p.e)(),this._ray=Object(m.c)(),this._viewport=Object(b.g)(0,0,1,1),this._padding=Object(b.g)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(d.e)(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(l.d)(),this._projectionDirty=!0,this._projectionMatrix=Object(l.d)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(l.d)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(l.d)(),this._frustumDirty=!0,this._frustum=Object(g.b)(),this._fullViewport=Object(b.e)(),this.pixelRatio=1,this.relativeElevation=0,Object(s.k)(t)&&Object(f.k)(this._ray.origin,t),this._center=Object(s.k)(r)?Object(p.c)(r):Object(p.e)(),this._up=Object(s.k)(n)?Object(p.c)(n):Object(p.g)(0,0,1)}return Object(n.a)(e,[{key:"eye",get:function(){return this._ray.origin},set:function(e){this._compareAndSetView(e,this._ray.origin)}},{key:"center",get:function(){return this._center},set:function(e){this._compareAndSetView(e,this._center)}},{key:"ray",get:function(){return Object(f.j)(this._ray.direction,this.center,this.eye),this._ray}},{key:"up",get:function(){return this._up},set:function(e){this._compareAndSetView(e,this._up)}},{key:"viewMatrix",get:function(){return this._ensureViewClean(),this._viewMatrix},set:function(e){Object(u.d)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"viewForward",get:function(){return this._ensureViewClean(),this._viewForward}},{key:"viewUp",get:function(){return this._ensureViewClean(),this._viewUp}},{key:"viewRight",get:function(){return this._ensureViewClean(),this._viewRight}},{key:"nearFar",get:function(){return this._nearFar}},{key:"near",get:function(){return this._nearFar[0]},set:function(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"far",get:function(){return this._nearFar[1]},set:function(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewport",get:function(){return this._viewport},set:function(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}},{key:"x",get:function(){return this._viewport[0]},set:function(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"y",get:function(){return this._viewport[1]},set:function(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"width",get:function(){return this._viewport[2]},set:function(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"height",get:function(){return this._viewport[3]},set:function(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"fullWidth",get:function(){return this._viewport[2]+this._padding[1]+this._padding[3]},set:function(e){this.width=e-(this._padding[1]+this._padding[3])}},{key:"fullHeight",get:function(){return this._viewport[3]+this._padding[0]+this._padding[2]},set:function(e){this.height=e-(this._padding[0]+this._padding[2])}},{key:"fullViewport",get:function(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}},{key:"aspect",get:function(){return this.width/this.height}},{key:"padding",get:function(){return this._padding},set:function(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Object(v.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}},{key:"viewProjectionMatrix",get:function(){return this._viewProjectionDirty&&(Object(u.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}},{key:"projectionMatrix",get:function(){if(this._projectionDirty){var e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this.aspect;Object(u.k)(this._projectionMatrix,-i*(1+2*this._padding[3]/e),i*(1+2*this._padding[1]/e),-r*(1+2*this._padding[2]/t),r*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix},set:function(e){Object(u.d)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovX",get:function(){return Object(O.b)(this._fov,this.width,this.height)},set:function(e){this._fov=Object(O.d)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"fovY",get:function(){return Object(O.c)(this._fov,this.width,this.height)},set:function(e){this._fov=Object(O.e)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}},{key:"distance",get:function(){return Object(f.m)(this._center,this.eye)}},{key:"frustum",get:function(){return this._recomputeFrustum(),this._frustum}},{key:"viewInverseTransposeMatrix",get:function(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(u.a)(this._viewInverseTransposeMatrix,this.viewMatrix),Object(u.e)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}},{key:"depthNDCToWorld",value:function(e){var t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}},{key:"perRenderPixelRatio",get:function(){return Math.tan(this.fovX/2)/(this.width/2)}},{key:"perScreenPixelRatio",get:function(){return this.perRenderPixelRatio*this.pixelRatio}},{key:"aboveGround",get:function(){return this.relativeElevation&&this.relativeElevation>=0}},{key:"copyFrom",value:function(e){Object(f.k)(this._ray.origin,e.eye),Object(f.k)(this._center,e.center),Object(f.k)(this._up,e.up),Object(v.c)(this._viewport,e.viewport),Object(v.c)(this._padding,e.padding),Object(h.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;var t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(Object(u.d)(this._viewMatrix,e.viewMatrix),Object(f.k)(this._viewRight,e.viewRight),Object(f.k)(this._viewUp,e.viewUp),Object(f.k)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:(Object(u.d)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(Object(g.a)(e.frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(u.d)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(v.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}},{key:"copyViewFrom",value:function(e){this.eye=e.eye,this.center=e.center,this.up=e.up}},{key:"clone",value:function(){return(new e).copyFrom(this)}},{key:"equals",value:function(e){return Object(f.o)(this.eye,e.eye)&&Object(f.o)(this._center,e.center)&&Object(f.o)(this._up,e.up)&&Object(v.g)(this._viewport,e.viewport)&&Object(v.g)(this._padding,e.padding)&&Object(h.k)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}},{key:"almostEquals",value:function(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;var t=5e-4;Object(f.A)(T,e.eye,e.center),Object(f.A)(S,this.eye,this._center);var r=Object(f.h)(T,S),i=Object(f.B)(T),n=Object(f.B)(S);return r*r>=(1-1e-10)*i*n&&Object(f.C)(e.eye,this.eye)<Math.max(i,n)*t*t&&Object(v.i)(e.padding,this._padding)<.5&&Object(v.i)(e.viewport,this._viewport)<.5}},{key:"computeRenderPixelSizeAt",value:function(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}},{key:"computeRenderPixelSizeAtDist",value:function(e){return e*this.perRenderPixelRatio}},{key:"computeScreenPixelSizeAt",value:function(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}},{key:"viewDirectionDistance",value:function(e){return Math.abs(Object(y.d)(this.viewForward,Object(f.j)(T,e,this.eye)))}},{key:"computeScreenPixelSizeAtDist",value:function(e){return e*this.perScreenPixelRatio}},{key:"computeDistanceFromRadius",value:function(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}},{key:"getScreenCenter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(c.f)();return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}},{key:"getRenderCenter",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.5;return e||(e=Object(c.d)()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*r,e.length>2&&(e[2]=.5),e}},{key:"setGLViewport",value:function(e){var t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}},{key:"applyProjection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e!==x&&Object(f.k)(x,e),x[3]=1,r&&(t[2]=-x[2]),Object(v.m)(x,x,this.projectionMatrix),Object(f.e)(x,x,1/Math.abs(x[3]));var i=this.fullViewport;return t[0]=Object(o.m)(0,i[0]+i[2],.5+.5*x[0]),t[1]=Object(o.m)(0,i[1]+i[3],.5+.5*x[1]),r||(t[2]=.5*(x[2]+1)),t}},{key:"projectToScreen",value:function(e,t){this.projectToRenderScreen(e,R),this.renderToScreen(R,t)}},{key:"projectToRenderScreen",value:function(e,t){if(x[0]=e[0],x[1]=e[1],x[2]=e[2],x[3]=1,Object(v.m)(x,x,this.viewProjectionMatrix),0===x[3])return null;Object(f.e)(x,x,1/Math.abs(x[3]));var r=this.fullViewport;return"x"in t?(t.x=Object(o.m)(0,r[0]+r[2],.5+.5*x[0]),t.y=Object(o.m)(0,r[1]+r[3],.5+.5*x[1])):(t[0]=Object(o.m)(0,r[0]+r[2],.5+.5*x[0]),t[1]=Object(o.m)(0,r[1]+r[3],.5+.5*x[1]),t.length>2&&(t[2]=.5*(x[2]+1))),t}},{key:"unprojectFromScreen",value:function(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,R),t)}},{key:"unprojectFromRenderScreen",value:function(e,t){if(Object(u.m)(w,this.projectionMatrix,this.viewMatrix),!Object(u.a)(w,w))return null;var r=this.fullViewport;return x[0]=2*(e[0]-r[0])/r[2]-1,x[1]=2*(e[1]-r[1])/r[3]-1,x[2]=2*e[2]-1,x[3]=1,Object(v.m)(x,x,w),0===x[3]?null:(t[0]=x[0]/x[3],t[1]=x[1]/x[3],t[2]=x[2]/x[3],t)}},{key:"constrainWindowSize",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r,n=e*this.pixelRatio,a=t*this.pixelRatio,o=Math.max(n-r/2,0),s=Math.max(this.fullHeight-a-i/2,0),c=-Math.min(n-r/2,0),u=-Math.min(this.fullHeight-a-i/2,0);return[o,s,r-c- -Math.min(this.fullWidth-n-r/2,0),i-u- -Math.min(a-i/2,0)]}},{key:"computeUp",value:function(e){1===e?this.computeUpGlobal():this.computeUpLocal()}},{key:"screenToRender",value:function(e,t){var r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}},{key:"renderToScreen",value:function(e,t){var r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}},{key:"computeUpGlobal",value:function(){Object(f.j)(T,this.center,this.eye);var e=Object(f.p)(this.center);e<1?(Object(f.w)(this._up,0,0,1),this._markViewDirty()):Math.abs(Object(f.h)(T,this.center))>.9999*Object(f.p)(T)*e||(Object(f.g)(this._up,T,this.center),Object(f.g)(this._up,this._up,T),Object(f.r)(this._up,this._up),this._markViewDirty())}},{key:"computeUpLocal",value:function(){Object(f.v)(T,this.eye,this.center),Math.abs(T[2])<=.9999&&(Object(f.e)(T,T,T[2]),Object(f.w)(this._up,-T[0],-T[1],1-T[2]),Object(f.r)(this._up,this._up),this._markViewDirty())}},{key:"_compareAndSetView",value:function(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?Object(f.o)(e,t)||(Object(f.k)(t,e),this._markViewDirty()):j.warn("Camera vector contains invalid number, ignoring value")}},{key:"_markViewDirty",value:function(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}},{key:"_recomputeFrustum",value:function(){this._frustumDirty&&(Object(g.c)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}},{key:"_ensureViewClean",value:function(){this._viewDirty&&(Object(u.l)(this._viewMatrix,this.eye,this._center,this._up),Object(f.w)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(f.w)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(f.w)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}]),e}(),x=Object(b.e)(),w=Object(l.d)(),T=Object(p.e)(),S=Object(p.e)(),R=Object(c.d)();t.a=_},823:function(e,t,r){"use strict";r.d(t,"a",(function(){return v}));r(5),r(6);var i=r(2),n=r(3),a=r(4),o=r(219),s=r(78),c=r(104),u=r(11),l=r(85),h=r(384),d=r(217),f=r(495),p=r(218),v=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Object(o.a)(),u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,h=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,d=arguments.length>7&&void 0!==arguments[7]&&arguments[7];Object(i.a)(this,e),this.data=t,this.material=r,this.layerUid=n,this.graphicUid=a,this.id=s,this.boundingInfo=u,this.calculateShaderTransformation=h,this.castShadow=d,this.boundingSphere=Object(l.e)(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=Object(c.d)(),this._shaderTransformationDirty=!0}return Object(n.a)(e,[{key:"transformation",get:function(){return this._transformation}},{key:"updateTransformation",value:function(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}},{key:"shaderTransformationChanged",value:function(){this._shaderTransformationDirty=!0}},{key:"computeBoundingSphere",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Object(h.c)(e);Object(a.j)(this.boundingInfo)||(Object(u.q)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*r)}},{key:"hasShaderTransformation",get:function(){return Object(a.k)(this.calculateShaderTransformation)}},{key:"primitiveType",get:function(){return this.data.primitiveType}},{key:"getShaderTransformation",value:function(){return Object(a.j)(this.calculateShaderTransformation)?Object(a.t)(this.transformation,c.a):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Object(c.d)()),Object(s.d)(this._shaderTransformation,this.calculateShaderTransformation(Object(a.t)(this.transformation,c.a))),this._shaderTransformationDirty=!1),this._shaderTransformation)}},{key:"computeAttachmentOrigin",value:function(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(Object(a.k)(this._transformation)&&Object(u.q)(e,e,this._transformation),!0);var t=this.indices.get("position"),r=this.vertexAttributes.get("position");return!!Object(d.c)(r,t,e)&&(Object(a.k)(this._transformation)&&Object(u.q)(e,e,this._transformation),!0)}},{key:"indices",get:function(){return this.data.indices}},{key:"vertexAttributes",get:function(){return this.data.vertexAttributes}},{key:"addHighlight",value:function(){var e=new f.a(0),t=this.instanceParameters;return t.highlights=Object(p.b)(t.highlights,e),e}},{key:"removeHighlight",value:function(e){var t=this.instanceParameters;t.highlights=Object(p.g)(t.highlights,e)}}]),e}()},824:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return v})),r.d(t,"c",(function(){return g})),r.d(t,"d",(function(){return b}));var i=r(4),n=r(104),a=r(22),o=r(108),s=r(163),c=r(146),u=r(213),l=r(517),h=r(518),d=r(414),f=Object(a.e)();function p(e,t,r,a,c,u,h,p,v,b){var g=r?r.length:0,m=e.clippingExtent;if(Object(o.p)(t,f,e.elevationProvider.spatialReference),Object(i.k)(m)&&!Object(s.e)(m,f))return null;var y=e.renderCoordsHelper.spatialReference;Object(o.p)(t,f,y);for(var O=e.localOriginFactory.getOrigin(f),j=new d.a({castShadow:!1,metadata:{layerUid:p,graphicUid:v,usesVerticalDistanceToGround:!0}}),_=0;_<g;_++){var x=c?c[_]:n.a;j.addGeometry(r[_],a[_],x,u,O,b)}return{object:j,sampledElevation:Object(l.b)(j,t,e.elevationProvider,e.renderCoordsHelper,h)}}function v(e,t,r){var i=e.elevationContext,n=r.spatialReference;Object(o.p)(t,f,n),i.centerPointInElevationSR=Object(u.g)(f[0],f[1],t.hasZ?f[2]:0,n)}function b(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Object(h.a)(e);case"polyline":var t=e.paths[0];if(!t||0===t.length)return null;var r=Object(c.f)(t,Object(c.e)(t)/2);return Object(u.g)(r[0],r[1],r[2],e.spatialReference);case"mesh":return e.origin}return null}function g(e,t,r,i,n){var a=new Float64Array(3*e.length),o=new Float64Array(a.length);e.forEach((function(e,t){a[3*t+0]=e[0],a[3*t+1]=e[1],a[3*t+2]=e.length>2?e[2]:0}));var s=Object(l.c)(a,t,0,o,0,a,0,a.length/3,r,i,n),c=null!=s;return{numVertices:e.length,position:a,mapPosition:o,projectionSuccess:c,sampledElevation:s}}},839:function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return s}));var i=r(15),n=r(708),a=r(146),o=r(814);function s(e){var t,r=c(e.rings,e.hasZ,1),a=[],s=0,u=0,l=Object(i.a)(r.polygons);try{var h=function(){var e=t.value,i=e.count,o=e.index,c=new Float64Array(r.position.buffer,3*o*r.position.BYTES_PER_ELEMENT,3*i),l=e.holeIndices.map((function(e){return e-o})),h=new Uint32Array(Object(n.a)(c,l,3));a.push({position:c,faces:h}),s+=c.length,u+=h.length};for(l.s();!(t=l.n()).done;)h()}catch(p){l.e(p)}finally{l.f()}var d=function(e,t,r){if(1===e.length)return e[0];var n,a=new Float64Array(t),o=new Uint32Array(r),s=0,c=0,u=0,l=Object(i.a)(e);try{for(l.s();!(n=l.n()).done;){for(var h=n.value,d=0;d<h.position.length;d++)a[s++]=h.position[d];for(var f=0;f<h.faces.length;f++)o[c++]=h.faces[f]+u;u=s/3}}catch(p){l.e(p)}finally{l.f()}return{position:a,faces:o}}(a,s,u),f=Object(o.a)(d.position.buffer,6,{originalIndices:d.faces});return d.position=new Float64Array(f.buffer),d.faces=f.indices,d}function c(e,t,r){for(var i=e.length,n=new Array(i),a=new Array(i),o=new Array(i),s=0,c=0,h=0,d=0,f=0;f<i;++f)d+=e[f].length;for(var p=new Float64Array(3*d),v=0,b=i-1;b>=0;b--){var g=e[b],m=1===r&&l(g);if(m&&1!==i)n[s++]=g;else{for(var y=g.length,O=0;O<s;++O)y+=n[O].length;var j={index:v,pathLengths:new Array(s+1),count:y,holeIndices:new Array(s)};j.pathLengths[0]=g.length,g.length>0&&(o[h++]={index:v,count:g.length}),v=m?u(g,g.length-1,-1,p,v,g.length,t):u(g,0,1,p,v,g.length,t);for(var _=0;_<s;++_){var x=n[_];j.holeIndices[_]=v,j.pathLengths[_+1]=x.length,x.length>0&&(o[h++]={index:v,count:x.length}),v=u(x,0,1,p,v,x.length,t)}s=0,j.count>0&&(a[c++]=j)}}for(var w=0;w<s;++w){var T=n[w];T.length>0&&(o[h++]={index:v,count:T.length}),v=u(T,0,1,p,v,T.length,t)}return c<i&&(a.length=c),h<i&&(o.length=h),{position:p,polygons:a,outlines:o}}function u(e,t,r,i,n,a,o){n*=3;for(var s=0;s<a;++s){var c=e[t];i[n++]=c[0],i[n++]=c[1],i[n++]=o?c[2]:0,t+=r}return n/3}function l(e){return!Object(a.g)(e,!1,!1)}},842:function(e,t,r){"use strict";r.d(t,"a",(function(){return v})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return m}));var i=r(15),n=r(40),a=r(4),o=r(90),s=r(11),c=r(22),u=r(108),l=r(839),h=r(896),d=r(517),f=r(924),p=r(158);function v(e){var t=[],r=[];!function(e,t,r){for(var i=e.attributeData.position,n=e.removeDuplicateStartEnd,a=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&1===n,s=i.length/3-(a?1:0),c=new Uint32Array(2*(s-1)),u=a?Object(o.m)(i,0,i.length-3):i,l=0,h=0;h<s-1;h++)c[l++]=h,c[l++]=h+1;t.push(["position",{size:3,data:u,exclusive:a}]),r.push(["position",c])}(e,r,t);var i=r[0][1].data,c=t[0][1].length,u=new Uint16Array(c);return function(e,t,r){var i=e.attributeData.mapPosition;Object(a.j)(i)||(r.push(["mapPos",r[0][1]]),t.push(["mapPos",{size:3,data:i}]))}(e,r,t),function(e,t,r,i){if(Object(a.k)(e.attributeData.colorFeature))return;var n=e.attributeData.color;t.push(["color",{size:4,data:Object(a.t)(n,h.c)}]),r.push(["color",i])}(e,r,t,u),function(e,t,r,i){if(Object(a.k)(e.attributeData.sizeFeature))return;var n=e.attributeData.size;t.push(["size",{size:1,data:[Object(a.t)(n,1)]}]),r.push(["size",i])}(e,r,t,u),function(e,t,r,i){var n=e.attributeData.colorFeature;Object(a.j)(n)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["color",i]))}(e,r,t,u),function(e,t,r,i){var n=e.attributeData.sizeFeature;Object(a.j)(n)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["sizeFeatureAttribute",i]))}(e,r,t,u),function(e,t,r,i){var n=e.attributeData.opacityFeature;Object(a.j)(n)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["opacityFeatureAttribute",i]))}(e,r,t,u),function(e,t,r,i){if("round"!==e.join)return;var o=i.length/3,c=new Float32Array(o),u=O,l=j;Object(s.w)(u,0,0,0);for(var h=Object(a.t)(e.uniformSize,1),d=-1;d<o;++d){var f=d<0?o+d:d,p=(d+1)%o;if(Object(s.w)(l,i[3*p+0]-i[3*f+0],i[3*p+1]-i[3*f+1],i[3*p+2]-i[3*f+2]),Object(s.r)(l,l),d>=0){var v=(Math.PI-Object(n.b)(Object(s.h)(u,l)))*_*1*y(h);c[d]=Math.max(Math.floor(v),0)}Object(s.e)(u,l,-1)}t.push(["subdivisions",{size:1,data:c}]),r.push(["subdivisions",r[0][1]])}(e,r,t,i),new p.a(r,t,2)}function b(e,t,r,i){var n="polygon"===e.type?1:0,a="polygon"===e.type?e.rings:e.paths,o=Object(l.a)(a,e.hasZ,n),s=o.position,c=o.outlines,u=new Float64Array(s.length),h=Object(d.c)(s,e.spatialReference,0,u,0,s,0,s.length/3,t,r,i),f=null!=h;return{lines:f?g(c,s,u):[],projectionSuccess:f,sampledElevation:h}}function g(e,t,r){var n,a=new Array,o=Object(i.a)(e);try{for(o.s();!(n=o.n()).done;){var s=n.value,c=s.index,u=s.count;if(!(u<=1)){var l=3*c,h=l+3*u;a.push({position:t.subarray(l,h),mapPosition:r?r.subarray(l,h):void 0})}}}catch(d){o.e(d)}finally{o.f()}return a}function m(e,t){for(var r="polygon"===e.type?1:0,i="polygon"===e.type?e.rings:e.paths,n=Object(l.a)(i,!1,r),a=n.position,o=n.outlines,s=Object(u.m)(a,e.spatialReference,0,a,t,0,a.length/3),c=2;c<a.length;c+=3)a[c]=f.a;return{lines:s?g(o,a):[],projectionSuccess:s}}function y(e){return 1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294)}var O=Object(c.e)(),j=Object(c.e)(),_=4/Math.PI},843:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var i,n,a,o,s=r(29),c=r(27);function u(e,t){1===t.viewingMode?e.vertex.code.add(Object(c.a)(i||(i=Object(s.a)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):e.vertex.code.add(Object(c.a)(n||(n=Object(s.a)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),1===t.viewingMode?e.vertex.code.add(Object(c.a)(a||(a=Object(s.a)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):e.vertex.code.add(Object(c.a)(o||(o=Object(s.a)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}},845:function(e,t,r){"use strict";r.d(t,"a",(function(){return g})),r.d(t,"b",(function(){return x})),r.d(t,"c",(function(){return _}));var i=r(2),n=r(3),a=r(4),o=r(145),s=r(267),c=r(78),u=r(104),l=r(480),h=r(291),d=r(11),f=r(73),p=r(22),v=r(85),b=r(124),g=function(){function e(){Object(i.a)(this,e),this._transform=Object(u.d)(),this._transformInverse=new m({value:this._transform},c.a,u.d),this._transformInverseTranspose=new m(this._transformInverse,c.e,u.d),this._transformTranspose=new m({value:this._transform},c.e,u.d),this._transformInverseRotation=new m({value:this._transform},o.j,s.b)}return Object(n.a)(e,[{key:"invalidateLazyTransforms",value:function(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}},{key:"transform",get:function(){return this._transform}},{key:"inverse",get:function(){return this._transformInverse.value}},{key:"inverseTranspose",get:function(){return this._transformInverseTranspose.value}},{key:"inverseRotation",get:function(){return this._transformInverseRotation.value}},{key:"transpose",get:function(){return this._transformTranspose.value}},{key:"setTransformMatrix",value:function(e){Object(c.d)(this._transform,e)}},{key:"multiplyTransform",value:function(e){Object(c.m)(this._transform,this._transform,e)}},{key:"set",value:function(e){Object(c.d)(this._transform,e),this.invalidateLazyTransforms()}},{key:"setAndInvalidateLazyTransforms",value:function(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this.invalidateLazyTransforms()}}]),e}(),m=function(){function e(t,r,n){Object(i.a)(this,e),this.original=t,this.update=r,this.dirty=!0,this.transform=n()}return Object(n.a)(e,[{key:"invalidate",value:function(){this.dirty=!0}},{key:"value",get:function(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}]),e}(),y=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(i.a)(this,e),this.offset=t,this.tmpVertex=Object(p.e)()}return Object(n.a)(e,[{key:"applyToVertex",value:function(e,t,r){var i=e+this.localOrigin[0],n=t+this.localOrigin[1],a=r+this.localOrigin[2],o=this.offset/Math.sqrt(i*i+n*n+a*a);return this.tmpVertex[0]=e+i*o,this.tmpVertex[1]=t+n*o,this.tmpVertex[2]=r+a*o,this.tmpVertex}},{key:"applyToAabb",value:function(e){var t=e[0]+this.localOrigin[0],r=e[1]+this.localOrigin[1],i=e[2]+this.localOrigin[2],n=e[3]+this.localOrigin[0],a=e[4]+this.localOrigin[1],o=e[5]+this.localOrigin[2],s=this.offset/Math.sqrt(t*t+r*r+i*i);e[0]+=t*s,e[1]+=r*s,e[2]+=i*s;var c=this.offset/Math.sqrt(n*n+a*a+o*o);return e[3]+=n*c,e[4]+=a*c,e[5]+=o*c,e}}]),e}(),O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(i.a)(this,e),this.offset=t,this.componentLocalOriginLength=0,this.tmpVertex=Object(p.e)(),this.mbs=Object(v.e)(),this.obb={center:Object(p.e)(),halfSize:Object(f.b)(),quaternion:null}}return Object(n.a)(e,[{key:"localOrigin",set:function(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}},{key:"applyToVertex",value:function(e,t,r){var i=e,n=t,a=r+this.componentLocalOriginLength,o=this.offset/Math.sqrt(i*i+n*n+a*a);return this.tmpVertex[0]=e+i*o,this.tmpVertex[1]=t+n*o,this.tmpVertex[2]=r+a*o,this.tmpVertex}},{key:"applyToAabb",value:function(e){var t=e[0],r=e[1],i=e[2]+this.componentLocalOriginLength,n=e[3],a=e[4],o=e[5]+this.componentLocalOriginLength,s=this.offset/Math.sqrt(t*t+r*r+i*i);e[0]+=t*s,e[1]+=r*s,e[2]+=i*s;var c=this.offset/Math.sqrt(n*n+a*a+o*o);return e[3]+=n*c,e[4]+=a*c,e[5]+=o*c,e}},{key:"applyToMbs",value:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/t;return this.mbs[0]=e[0]+e[0]*r,this.mbs[1]=e[1]+e[1]*r,this.mbs[2]=e[2]+e[2]*r,this.mbs[3]=e[3]+e[3]*this.offset/t,this.mbs}},{key:"applyToObb",value:function(e){var t=e.center,r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.obb.center[0]=t[0]+t[0]*r,this.obb.center[1]=t[1]+t[1]*r,this.obb.center[2]=t[2]+t[2]*r,Object(d.u)(this.obb.halfSize,e.halfSize,e.quaternion),Object(d.f)(this.obb.halfSize,this.obb.halfSize,e.center);var i=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*i,this.obb.halfSize[1]+=this.obb.halfSize[1]*i,this.obb.halfSize[2]+=this.obb.halfSize[2]*i,Object(d.j)(this.obb.halfSize,this.obb.halfSize,e.center),Object(l.a)(w,e.quaternion),Object(d.u)(this.obb.halfSize,this.obb.halfSize,w),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}}]),e}(),j=new(function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;Object(i.a)(this,e),this.offset=t,this.sphere=Object(b.b)(),this.tmpVertex=Object(p.e)()}return Object(n.a)(e,[{key:"applyToVertex",value:function(e,t,r){var i=this.objectTransform.transform,n=i[0]*e+i[4]*t+i[8]*r+i[12],a=i[1]*e+i[5]*t+i[9]*r+i[13],o=i[2]*e+i[6]*t+i[10]*r+i[14],s=this.offset/Math.sqrt(n*n+a*a+o*o);n+=n*s,a+=a*s,o+=o*s;var c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*a+c[8]*o+c[12],this.tmpVertex[1]=c[1]*n+c[5]*a+c[9]*o+c[13],this.tmpVertex[2]=c[2]*n+c[6]*a+c[10]*o+c[14],this.tmpVertex}},{key:"applyToMinMax",value:function(e,t){var r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;var i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i}},{key:"applyToAabb",value:function(e){var t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;var r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}},{key:"applyToBoundingSphere",value:function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/t;return this.sphere[0]=e[0]+e[0]*r,this.sphere[1]=e[1]+e[1]*r,this.sphere[2]=e[2]+e[2]*r,this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}}]),e}());function _(e){return Object(a.k)(e)?(j.offset=e,j):null}new O;new y;var x="terrain",w=Object(h.b)()},895:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var i=r(4);function n(e){return Object(i.j)(e)?e:e.slice()}},896:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return a})),r.d(t,"c",(function(){return o}));var i=r(85),n=1.2,a=i.b,o=i.a},897:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return f}));var i=r(2),n=r(3),a=r(78),o=r(104),s=r(11),c=r(22),u=r(77),l=r(85),h=(r(797),r(137)),d=r(414);var f=function(){function e(){Object(i.a)(this,e),this.min=new p,this.max=new p,this.hud=new p,this.ground=new p}return Object(n.a)(e,[{key:"init",value:function(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}]),e}(),p=function(){function e(t){Object(i.a)(this,e),this.normal=Object(c.e)(),this.transformation=Object(o.d)(),this._ray=Object(h.c)(),this.init(t)}return Object(n.a)(e,[{key:"ray",get:function(){return this._ray}},{key:"hasIntersectionPoint",get:function(){return null!=this.dist}},{key:"distanceInRenderSpace",get:function(){if(null!=this.dist)return Object(s.e)(v,this.ray.direction,this.dist),Object(s.p)(v)}},{key:"getIntersectionPoint",value:function(e){return!!this.hasIntersectionPoint&&(Object(s.e)(v,this.ray.direction,this.dist),Object(s.f)(e,this.ray.origin,v),!0)}},{key:"getTransformedNormal",value:function(e){return Object(s.k)(b,this.normal),b[3]=0,Object(u.m)(b,b,this.transformation),Object(s.k)(e,b),Object(s.r)(e,e),e}},{key:"init",value:function(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?Object(h.b)(e,this._ray):this._ray=Object(h.c)()}},{key:"set",value:function(e,t,r,i,n,o,u,l,h,f){e instanceof d.a&&(e={type:"stage",obj:e}),this.dist=r,Object(s.k)(this.normal,i),Object(a.d)(this.transformation,n),this.target=e,this.name=t,this.drapedLayerOrder=o,this.center=u?Object(c.c)(u):null,this.geometryId=l,this.triangleNr=h,this.drapedLayerGraphicOrder=f}},{key:"copyFrom",value:function(e){Object(h.b)(e.ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?Object(c.c)(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,Object(s.k)(this.normal,e.normal),Object(a.d)(this.transformation,e.transformation)}}]),e}(),v=(Object(c.e)(),Object(c.e)()),b=Object(l.e)()},898:function(e,t,r){"use strict";r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return c}));var i,n=r(29),a=r(952),o=r(27);function s(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(a.b),e.fragment.code.add(Object(o.a)(i||(i=Object(n.a)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture2D(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}function c(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},899:function(e,t,r){"use strict";r.d(t,"a",(function(){return M})),r.d(t,"b",(function(){return k}));var i,n,a,o,s,c,u,l,h,d,f=r(29),p=r(764),v=r(201),b=r(515),g=r(236),m=r(233),y=r(231),O=r(843),j=r(744),_=r(1008),x=r(898),w=r(234),T=r(336),S=r(27),R=r(230);function k(e){var t=new R.a;return t.include(b.a,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(O.a,e),t.include(p.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(Object(S.a)(i||(i=Object(f.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),S.a.float(w.c),e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",0===e.output?"forwardLinearDepth();":""))),e.multipassTerrainEnabled&&(t.fragment.include(m.a),t.include(y.b,e)),7===e.output&&(t.include(v.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(S.a)(n||(n=Object(f.a)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""))),0===e.output&&(t.include(x.a,e),t.include(v.a,e),e.receiveShadows&&t.include(j.a,e),t.include(_.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(T.a),t.fragment.code.add(Object(S.a)(a||(a=Object(f.a)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - camPos);\n        float shadow = ",";\n        vec4 vPosView = view*vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?Object(S.a)(o||(o=Object(f.a)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),2===e.output&&(t.include(O.a,e),t.include(x.a,e),t.include(v.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(Object(S.a)(s||(s=Object(f.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),S.a.float(w.c))),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(Object(S.a)(c||(c=Object(f.a)(["void main() {\ndiscardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\ngl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n}"]))))),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(S.a)(u||(u=Object(f.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),S.a.float(w.c))),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(S.a)(l||(l=Object(f.a)(["void main() {\ngl_FragColor = waterColor;\n}"]))))),4===e.output&&(t.include(g.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(S.a)(h||(h=Object(f.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),S.a.float(w.c))),t.include(v.a,e),t.fragment.code.add(Object(S.a)(d||(d=Object(f.a)(["void main() {\ndiscardBySlice(vpos);\noutputHighlight();\n}"]))))),t}var M=Object.freeze({__proto__:null,build:k})},900:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return c}));var i,n=r(29),a=r(550),o=r(27),s=r(230);function c(){var e=new s.a;return e.include(a.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(Object(o.a)(i||(i=Object(n.a)(["void main() {\nvec4 texColor = texture2D(tex, uv);\ngl_FragColor = texColor * color;\n}"])))),e}var u=Object.freeze({__proto__:null,build:c})},905:function(e,t,r){"use strict";r.d(t,"a",(function(){return y})),r.d(t,"b",(function(){return m}));var i,n,a,o,s,c,u=r(29),l=r(201),h=r(515),d=r(528),f=r(236),p=r(551),v=r(234),b=r(27),g=r(230);function m(e){var t=new g.a;return t.include(h.a,{linearDepth:!1}),t.include(d.a,e),t.include(p.a,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(b.a)(i||(i=Object(u.a)(["void main(void) {\nvpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);"])))),e.stippleEnabled&&(t.attributes.add("auxpos1","vec3"),t.vertex.uniforms.add("ndcToPixel","vec2"),t.vertex.code.add(Object(b.a)(n||(n=Object(u.a)(["\n    vec4 vpos2 = transformPosition(proj, view, auxpos1);\n    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);\n\n    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;\n    ","\n\n    // Cancel out perspective correct interpolation because we want this length the really represent\n    // the screen distance\n    stipplePatternUv *= gl_Position.w;\n    "])),e.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""))),t.vertex.code.add(Object(b.a)(a||(a=Object(u.a)(["}"])))),4===e.output&&t.include(f.a),t.include(l.a,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(Object(b.a)(o||(o=Object(u.a)(["\n  void main() {\n    discardBySlice(vpos);\n\n    vec4 color = ",";\n\n    float stippleAlpha = getStippleAlpha();\n    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);\n\n    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);\n\n    if (finalColor.a < ",") {\n      discard;\n    }\n\n    ","\n    ","\n  }\n  "])),e.attributeColor?"vColor":"constantColor",b.a.float(v.c),0===e.output?Object(b.a)(s||(s=Object(u.a)(["gl_FragColor = highlightSlice(finalColor, vpos);"]))):"",4===e.output?Object(b.a)(c||(c=Object(u.a)(["outputHighlight();"]))):"")),t}var y=Object.freeze({__proto__:null,build:m})},924:function(e,t,r){"use strict";r.d(t,"a",(function(){return ht}));var i=r(7),n=r.n(i),a=r(10),o=r(24),s=r(15),c=r(2),u=r(3),l=r(5),h=r(6),d=r(0),f=r(34),p=r(48),v=r(13),b=r(242),g=r(4),m=r(127),y=r(581),O=r(25),j=r(1),_=(r(14),r(16),r(8)),x=r(78),w=r(47),T=r(22),S=r(796),R=r(40),k=r(77),M=r(97),C=r(948),E=function(){function e(t,r){Object(c.a)(this,e),this.index=t,this.renderTargets=r,this.extent=Object(M.k)(),this.resolution=0,this.viewport=Object(M.k)(),this.renderLocalOrigin=Object(C.a)(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[Object(M.k)(),Object(M.k)(),Object(M.k)()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(r.renderTargets.length).fill(!1)}return Object(u.a)(e,[{key:"getValidTarget",value:function(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}},{key:"needsColorWithoutRasterImage",get:function(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}},{key:"getColorTexture",value:function(e){var t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}},{key:"getNormalTexture",value:function(e){var t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}},{key:"draw",value:function(e,t){var r,i=this.computeRenderTargetValidityBitfield(),n=this.needsColorWithoutRasterImage,a=Object(s.a)(this.renderTargets.renderTargets);try{for(a.s();!(r=a.n()).done;){var o=r.value;1===o.type&&!1===n?this.validTargets[o.type]=!1:this.validTargets[o.type]=e.drawTarget(this,o,t)}}catch(c){a.e(c)}finally{a.f()}return i^this.computeRenderTargetValidityBitfield()?0:1}},{key:"computeRenderTargetValidityBitfield",value:function(){var e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}},{key:"setupGeometryViewsCyclical",value:function(e){this.setupGeometryViewsDirect();var t=.001*e.range;if(this.extent[0]-t<=e.min){var r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(M.t)(this.extent,e.range,0,r)}if(this.extent[2]+t>=e.max){var i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(M.t)(this.extent,-e.range,0,i)}}},{key:"setupGeometryViewsDirect",value:function(){this.canvasGeometries.numViews=1,Object(M.u)(this.canvasGeometries.extents[0],this.extent),Object(k.l)(this.viewport,0,0,this.resolution,this.resolution)}},{key:"hasSomeSizedView",value:function(){for(var e=0;e<this.canvasGeometries.numViews;e++){var t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},{key:"applyViewport",value:function(e){var t=this.viewport;0===this.index?e.setViewport(t[0],t[1],t[2],t[3]):e.setViewport(t[0]+this.resolution,t[1],t[2],t[3])}}]),e}();var D=r(478),P=r(134),I=r(376),A=(r(103),r(229),r(334),r(98)),L=r(200),z=function(){function e(t,r){Object(c.a)(this,e),this.size=Object(D.a)(),this._fbo=null,this._fbo=new I.a(t,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:r,maxAnisotropy:8,width:0,height:0})}return Object(u.a)(e,[{key:"dispose",value:function(){this._fbo=Object(g.f)(this._fbo)}},{key:"getTexture",value:function(){return this._fbo?this._fbo.colorTexture:null}},{key:"isValid",value:function(){return null!==this._fbo}},{key:"resize",value:function(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}},{key:"bind",value:function(e){e.bindFramebuffer(this._fbo)}},{key:"generateMipMap",value:function(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}},{key:"disposeRenderTargetMemory",value:function(){var e;null==(e=this._fbo)||e.resize(0,0)}},{key:"gpuMemoryUsage",get:function(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}]),e}(),H=function(){function e(t){Object(c.a)(this,e),this.renderTargets=null;var r=function(e,r){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return{type:r,fbo:new z(t,i),renderPass:e,valid:!1,lastUsed:1/0}};this.renderTargets=[r(0,0),r(0,1),r(5,2,!1),r(3,3),r(0,4)]}return Object(u.a)(e,[{key:"getTarget",value:function(e){return this.renderTargets[e].fbo}},{key:"dispose",value:function(){var e,t=Object(s.a)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.dispose()}}catch(r){t.e(r)}finally{t.f()}}},{key:"disposeRenderTargetMemory",value:function(){var e,t=Object(s.a)(this.renderTargets);try{for(t.s();!(e=t.n()).done;){e.value.fbo.disposeRenderTargetMemory()}}catch(r){t.e(r)}finally{t.f()}}},{key:"validateUsageForTarget",value:function(e,t,r){if(e)t.lastUsed=r;else if(r-t.lastUsed>N)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}},{key:"gpuMemoryUsage",get:function(){return this.renderTargets.reduce((function(e,t){return e+t.fbo.gpuMemoryUsage}),0)}}]),e}(),N=1e3,V=function e(t){Object(c.a)(this,e),this.technique=t,this.refCount=0,this.refZeroFrame=0},F=function(){function e(t){Object(c.a)(this,e),this._context=t,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}return Object(u.a)(e,[{key:"viewingMode",get:function(){return this._context.viewingMode}},{key:"constructionContext",get:function(){return this._context}},{key:"dispose",value:function(){this._perConstructorInstances.forEach((function(e){return e.forEach((function(e){return e.technique.dispose()}))})),this._perConstructorInstances.clear()}},{key:"acquire",value:function(e,t){var r=this,i=t.key,n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));var a=n.get(i);if(void 0===a){var o=new e(this._context,t,(function(){return r.release(o)}));a=new V(o),n.set(i,a)}return++a.refCount,a.technique}},{key:"releaseAndAcquire",value:function(e,t,r){if(Object(g.k)(r)){if(t.key===r.key)return r;r.release()}return this.acquire(e,t)}},{key:"release",value:function(e){if(!Object(g.j)(e)){var t=this._perConstructorInstances.get(e.constructor).get(e.key);--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}}},{key:"frameUpdate",value:function(){var e=this;this._frameCounter++,this._perConstructorInstances.forEach((function(t,r){t.forEach((function(r,i){0===r.refCount&&r.refZeroFrame+e._keepAliveFrameCount<e._frameCounter&&(r.technique.dispose(),t.delete(i))})),0===t.size&&e._perConstructorInstances.delete(r)}))}},{key:"hotReload",value:function(){var e=Object(a.a)(n.a.mark((function e(){var t,r=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Array,this._perConstructorInstances.forEach((function(e,i){var o=function(){var e=Object(a.a)(n.a.mark((function e(t,i){var a;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=i.shader,e.t0=a,!e.t0){e.next=6;break}return e.next=5,a.reload();case 5:t.forEach((function(e){e.technique.reload(r._context)}));case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}();t.push(o(e,i))})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),e}(),G=r(571),U=r(822),W=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function B(e,t){return e+"_"+W.find((function(e){return e.output===t})).name}var q=r(75),Z=v.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep"),Y=function(){function e(t){Object(c.a)(this,e),this.refCnt=0,this.glMaterial=t}return Object(u.a)(e,[{key:"incRefCnt",value:function(){++this.refCnt}},{key:"decRefCnt",value:function(){--this.refCnt,Object(q.a)(this.refCnt>=0)}},{key:"getRefCnt",value:function(){return this.refCnt}},{key:"getGLMaterial",value:function(){return this.glMaterial}}]),e}(),Q=function(){function e(t,r,i){Object(c.a)(this,e),this._textureRep=t,this._techniqueRep=r,this.onMaterialChanged=i,this._id2glMaterialRef=new Map}return Object(u.a)(e,[{key:"dispose",value:function(){this._textureRep.dispose()}},{key:"acquire",value:function(e,t){this.ownMaterial(e);var r=B(e.id,t),i=this._id2glMaterialRef.get(r);if(null==i){var n=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return(i=new Y(n)).incRefCnt(),this._id2glMaterialRef.set(r,i),n}return i.incRefCnt(),i.getGLMaterial()}},{key:"release",value:function(e,t){var r=B(e.id,t),i=this._id2glMaterialRef.get(r);if(i.decRefCnt(),0===i.getRefCnt()){var n=i.getGLMaterial();n&&n.dispose(),this._id2glMaterialRef.delete(r)}}},{key:"materialChanged",value:function(e){var t,r=Object(s.a)(W);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(5!==i.output&&6!==i.output){var n=this._id2glMaterialRef.get(B(e.id,i.output));if(n&&n.getGLMaterial()){var a=n.getGLMaterial();a.updateParameters&&a.updateParameters()}}}}catch(o){r.e(o)}finally{r.f()}this.onMaterialChanged&&this.onMaterialChanged(e)}},{key:"ownMaterial",value:function(e){Object(g.k)(e.materialRepository)&&e.materialRepository!==this&&Z.error("Material is already owned by a different material repository"),e.materialRepository=this}}]),e}(),X=r(444),J=r(949),K=r(897),$=function(){function e(t){Object(c.a)(this,e),this.rctx=t,this.camera=null,this.lastFrameCamera=new U.a,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=ee,this.hasOccludees=!1}return Object(u.a)(e,[{key:"resetRenderOccludedMask",value:function(){this.renderOccludedMask=ee}},{key:"isHighlightPass",get:function(){return 5===this.pass}}]),e}(),ee=13,te=function(){function e(){Object(c.a)(this,e),this.adds=new m.a,this.removes=new m.a,this.updates=new m.a({allocator:function(e){return e||new re},deallocator:function(e){return e.renderGeometry=null,e}})}return Object(u.a)(e,[{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.updates.clear()}},{key:"prune",value:function(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}]),e}(),re=function e(){Object(c.a)(this,e)},ie=function e(){Object(c.a)(this,e),this.adds=new Array,this.removes=new Array,this.updates=new Array},ne=r(270);function ae(e){return e.data.indexCount>=1}var oe=r(28),se=r(104),ce=r(537),ue=function(){function e(t){Object(c.a)(this,e),null==t?t=16:t<65536&&(t=Object(R.o)(t)),this._array=new Float32Array(t),this._size=0}return Object(u.a)(e,[{key:"resize",value:function(e,t){if(this._size=e,this._size>this._array.length){for(var r=this._array.length||1;r<this._size;)r*=2;var i=new Float32Array(r);return t&&i.set(this._array),this._array=i,!0}var n=2*this._size;if(n<=this._array.length){for(var a=this._array.length;a>=n;)a=Math.floor(a/2);var o=new Float32Array(a);return t&&o.set(this._array.subarray(0,a)),this._array=o,!0}return!1}},{key:"append",value:function(e){var t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}},{key:"erase",value:function(e,t){for(var r=e;r<t;++r)this._array[r]=0}},{key:"array",get:function(){return this._array}},{key:"size",get:function(){return this._size}}]),e}(),le=r(950),he=function e(t,r,i,n,a,o){Object(c.a)(this,e),this.from=t,this.to=r,this.isVisible=i,this.hasHighlights=n,this.hasOccludees=a,this.transformation=o,null!=o&&(this.transformationNormal=Object(se.c)(o),Object(x.a)(this.transformationNormal,this.transformationNormal),Object(x.e)(this.transformationNormal,this.transformationNormal))};function de(e,t){var r=function(e){return{first:e.from,count:e.to-e.from}};if(0!==e.length){var i=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(i,t)){var n=t.from-i.first+t.to-t.from;i.count=n}else e.push(r(t))}else e.push(r(t))}var fe=r(218),pe=r(324);r(93);function ve(e,t,r){Object(g.k)(r)&&(r.drawCalls+=e,r.triangles+=t)}pe.a;var be=r(244),ge=function(){function e(t,r,i){Object(c.a)(this,e),this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=t,this._material=i,this._materialRep=r,this._glMaterials=Object(fe.a)(this._material,this._materialRep),this._bufferWriter=i.createBufferWriter()}return Object(u.a)(e,[{key:"dispose",value:function(){Object(fe.f)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((function(e){e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((function(e){e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}},{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&Object(b.b)(this._glMaterials,(function(e){return e instanceof le.a}))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"modify",value:function(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}},{key:"addAndRemoveGeometries",value:function(e,t){var r=this,i=this._bufferWriter,n=i.vertexBufferLayout,a=n.stride/4,o=this._dataByOrigin,c=function(e,t,r,i){var n,a=new Map,o=t.vertexBufferLayout.stride/4,c=function(r,i){var n=r.origin;if(!Object(g.j)(n)){var s=e.get(n.id),c=a.get(n.id);null==c&&(c={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:n.vec3},a.set(n.id,c));var u=t.elementCount(r.data)*o;i?(c.optimalCount+=u,c.sparseCount+=u,c.toAdd.push(r)):(c.optimalCount-=u,c.toRemove.push(r))}},u=Object(s.a)(r);try{for(u.s();!(n=u.n()).done;){c(n.value,!0)}}catch(d){u.e(d)}finally{u.f()}var l,h=Object(s.a)(i);try{for(h.s();!(l=h.n()).done;){c(l.value,!1)}}catch(d){h.e(d)}finally{h.f()}return a}(o,i,e,t);c.forEach((function(e,t){c.delete(t);var i=e.optimalCount,s=e.sparseCount,u=o.get(t);if(null==u)Object(q.a)(i>0),u=r.createData(n,i,e.origin),o.set(t,u);else if(0===i)return u.vao.dispose(!0),u.vao=null,void o.delete(t);var l=i<e.sparseCount/2,h=l?i:s,d=ye,f=u.buffer.size,p=u.buffer.array,v=u.buffer.resize(h,!1);l||v?r.removeAndRebuild(u,e.toRemove,a,p,d):e.toRemove.length>0?(r.removeByErasing(u,e.toRemove,a,d),e.toAdd.length>0&&(d.end=f)):(d.begin=f,d.end=f);var b=Oe;Object(q.j)(b,-e.origin[0],-e.origin[1],-e.origin[2]),r.append(u,e.toAdd,a,b,d);var g=u.vao.vertexBuffers.geometry;if(g.byteSize!==u.buffer.array.buffer.byteLength)g.setData(u.buffer.array);else{var m=d.begin,y=d.end;if(m<y){var O=u.buffer.array,j=4*m,_=4*y;g.setSubData(O,j,j,_)}}u.drawCommandsDirty=!0}))}},{key:"updateGeometries",value:function(e){var t,r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,n=Object(s.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value,o=a.updateType,c=a.renderGeometry,u=this._dataByOrigin.get(c.origin.id),l=u&&u.instances.get(c.id);if(!l)return;if(1&o&&(l.isVisible=c.instanceParameters.visible),9&o){var h=c.instanceParameters.visible;l.hasHighlights=!!c.instanceParameters.highlights&&h}if(16&o&&(l.hasOccludees=!!c.instanceParameters.occludees),6&o){var d=u.buffer.array,f=u.vao;Object(fe.c)(c,je,_e),r.write({transformation:je,invTranspTransformation:_e},c.data,r.vertexBufferLayout.createView(d.buffer),l.from),Object(q.a)(l.from+r.elementCount(c.data)===l.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(d,l.from*i*4,l.from*i*4,l.to*i*4)}u.drawCommandsDirty=!0}}catch(p){n.e(p)}finally{n.f()}}},{key:"updateRenderCommands",value:function(){var e=this;this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((function(t){t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Object(b.b)(t.instances,(function(r){return r.isVisible?(r.hasHighlights&&(e._hasHighlights=!0,t.hasHighlights=!0),r.hasOccludees&&(e._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees}))}));this._dataByOrigin.forEach((function(e){e.drawCommandsDirty&&(function(e){if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0!==e.instances.size){if(!me(e)){var t=4*e.buffer.size/Object(be.d)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}var r=function(e){return e.sort((function(e,t){return e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0}))}(Object(oe.a)(e.instances.values()));e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];var i,n=Object(s.a)(r);try{for(n.s();!(i=n.n()).done;){var a=i.value;a.isVisible&&(a.hasOccludees?de(e.drawCommandsOccludees,a):de(e.drawCommandsDefault,a),a.hasHighlights?de(e.drawCommandsHighlight,a):de(e.drawCommandsShadowHighlightRest,a))}}catch(c){n.e(c)}finally{n.f()}var o=function(e){var t,r=0,i=Object(s.a)(e);try{for(i.s();!(t=i.n()).done;)r+=t.value.count}catch(c){i.e(c)}finally{i.f()}return r/3};e.stats={default:o(e.drawCommandsDefault),highlight:o(e.drawCommandsHighlight),occludees:o(e.drawCommandsOccludees),shadowHighlightRest:o(e.drawCommandsShadowHighlightRest)}}}(e),e.drawCommandsDirty=!1)}))}},{key:"updateLogic",value:function(e){return this._material.update(e)}},{key:"render",value:function(e,t,r,i){var n=this,a=this._rctx,o=this._glMaterials.get(t),s=5===t||7===t,c=6===t,u=!(s||c);if(3===t&&null===e&&(e=22),!o||2!==o.ensureResources(a)||null!=e&&!o.beginSlot(e)||s&&!this._hasHighlights)return!1;o.ensureParameters(r);var l=o.getPipelineState(e,!1);a.setPipelineState(l);var h=o.technique;a.useProgram(h.program),o.bind(r);var d=!1;return this._dataByOrigin.forEach((function(t){if(!(Object(g.j)(t.drawCommandsDefault)&&Object(g.j)(t.drawCommandsHighlight)&&Object(g.j)(t.drawCommandsOccludees)&&Object(g.j)(t.drawCommandsShadowHighlightRest))&&(!s||t.hasHighlights)){r.origin=t.origin,h.bindDraw(r,{},{}),h.ensureAttributeLocations(t.vao),a.bindVAO(t.vao);var f=h.primitiveType,p=s?t.drawCommandsHighlight:c&&me(t)?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault;if(Object(g.k)(p)){n.renderCommands(a,f,p);var v=s?t.stats.highlight:c&&me(t)?t.stats.shadowHighlightRest:t.stats.default;ve(p.length,v,i),d=!0}if(u){var b=t.drawCommandsOccludees;if(Object(g.k)(b)){var m=o.getPipelineState(e,!0);a.setPipelineState(m),n.renderCommands(a,f,b),a.setPipelineState(l),ve(b.length,t.stats.occludees,i),d=!0}}}})),d}},{key:"renderCommands",value:function(e,t,r){for(var i=0;i<r.length;i++)e.drawArrays(t,r[i].first,r[i].count)}},{key:"createData",value:function(e,t,r){return{instances:new Map,vao:new L.a(this._rctx,this._material.vertexAttributeLocations,{geometry:Object(ce.a)(e)},{geometry:P.a.createVertex(this._rctx,35044)}),buffer:new ue(t),optimalCount:0,origin:r,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}},{key:"removeAndRebuild",value:function(e,t,r,i,n){var a,o=Object(s.a)(t);try{for(o.s();!(a=o.n()).done;){var c=a.value.id,u=e.instances.get(c);e.optimalCount-=(u.to-u.from)*r,e.instances.delete(c)}}catch(v){o.e(v)}finally{o.f()}var l=0,h=e.buffer.array;n.begin=0,n.end=0;var d=-1,f=-1,p=0;e.instances.forEach((function(e){var t=e.from*r,n=e.to*r,a=n-t;d!==f&&f!==t?(h.set(i.subarray(d,f),p),p+=f-d,d=t):-1===d&&(d=t),f=n,e.from=l/r,l+=a,e.to=l/r})),d!==f&&h.set(i.subarray(d,f),p),n.end=l}},{key:"removeByErasing",value:function(e,t,r,i){i.begin=1/0,i.end=-1/0;var n,a=-1,o=-1,c=Object(s.a)(t);try{for(c.s();!(n=c.n()).done;){var u=n.value.id,l=e.instances.get(u),h=l.from*r,d=l.to*r;a!==o&&o!==h?(e.buffer.erase(a,o),a=h):-1===a&&(a=h),o=d,e.instances.delete(u),e.optimalCount-=d-h,h<i.begin&&(i.begin=h),d>i.end&&(i.end=d)}}catch(f){c.e(f)}finally{c.f()}a!==o&&e.buffer.erase(a,o)}},{key:"append",value:function(e,t,r,i,n){var a,o=this._bufferWriter,c=Object(s.a)(t);try{for(c.s();!(a=c.n()).done;){var u=a.value,l=Object(g.k)(u.transformation)?Object(x.m)(je,i,u.transformation):i;Object(x.a)(_e,l),Object(x.e)(_e,_e);var h=n.end;o.write({transformation:l,invTranspTransformation:_e},u.data,o.vertexBufferLayout.createView(e.buffer.array.buffer),n.end/r);var d=o.elementCount(u.data)*r,f=h+d;Object(q.a)(null==e.instances.get(u.id));var p=u.instanceParameters.visible,v=!!u.instanceParameters.highlights&&p,b=!!u.instanceParameters.occludees,m=new he(h/r,f/r,p,v,b);e.instances.set(u.id,m),e.optimalCount+=d,n.end+=d}}catch(y){c.e(y)}finally{c.f()}}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),e}();function me(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}var ye={begin:0,end:0},Oe=Object(se.d)(),je=Object(se.d)(),_e=Object(se.d)(),xe=ge,we=function(e){Object(l.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(c.a)(this,r),(e=t.apply(this,arguments))._pending=new Te,e._changes=new te,e._materialRenderers=new Map,e._sortedMaterialRenderers=new m.a,e._hasHighlights=!1,e._hasWater=!1,e}return Object(u.a)(r,[{key:"dispose",value:function(){this._changes.prune(),this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}},{key:"updating",get:function(){return!this._pending.empty||this._changes.updates.length>0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return Object(b.b)(this._materialRenderers,(function(e){return e.rendersOccluded}))}},{key:"stopAnimationsAtTime",value:function(e){this._sortedMaterialRenderers.forAll((function(t){return Object(g.c)(t.material.animation,(function(t){return t.stopAtTime(e)}))}))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"commitChanges",value:function(){var e=this;if(!this.updating)return!1;this._processAddsRemoves();var t=function(e){var t=new Map,r=function(e){var r=t.get(e);return r||(r=new ie,t.set(e,r)),r};return e.adds.forAll((function(e){ae(e)&&r(e.material).adds.push(e)})),e.removes.forAll((function(e){ae(e)&&r(e.material).removes.push(e)})),e.updates.forAll((function(e){ae(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes),r=!1,i=!1,n=!1;return t.forEach((function(t,a){var o=e._materialRenderers.get(a);if(!o&&t.adds.length>0&&(o=new xe(e.rctx,e.materialRepository,a),e._materialRenderers.set(a,o),r=!0,i=!0,n=!0),o){var s=i||o.hasHighlights,c=n||o.hasWater;o.modify(t),i=i||s!==o.hasHighlights,n=n||c!==o.hasWater,o.isEmpty&&(e._materialRenderers.delete(a),o.dispose(),r=!0)}})),this._changes.clear(),r&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=Object(b.b)(this._materialRenderers,(function(e){return e.hasHighlights}))),n&&(this._hasWater=Object(b.b)(this._materialRenderers,(function(e){return e.hasWater}))),this.notifyChange("updating"),!0}},{key:"add",value:function(e){if(0!==e.length){var t,r=this._pending.empty,i=Object(s.a)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;this._pending.adds.add(n)}}catch(a){i.e(a)}finally{i.f()}r&&this.notifyChange("updating")}}},{key:"remove",value:function(e){var t,r=this._pending.empty,i=Object(s.a)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;this._pending.adds.has(n)?(this._pending.removed.add(n),this._pending.adds.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n)}}catch(a){i.e(a)}finally{i.f()}r&&!this._pending.empty&&this.notifyChange("updating")}},{key:"modify",value:function(e,t){var r,i=0===this._changes.updates.length,n=Object(s.a)(e);try{for(n.s();!(r=n.n()).done;){var a=r.value,o=this._changes.updates.pushNew();o.renderGeometry=a,o.updateType=t}}catch(c){n.e(c)}finally{n.f()}i&&this._changes.updates.length>0&&this.notifyChange("updating")}},{key:"updateLogic",value:function(e){var t=!1;return this._sortedMaterialRenderers.forAll((function(r){var i=r.materialRenderer;i.updateLogic&&i.updateLogic(e)&&(t=!0)})),t}},{key:"render",value:function(e,t){for(var r=0;r<this._sortedMaterialRenderers.length;r++){var i=this._sortedMaterialRenderers.data[r];Object(ne.c)(i.material,e)&&i.materialRenderer.render(null,e.pass,t,null)}}},{key:"updateSortedMaterialRenderers",value:function(){var e=this;this._sortedMaterialRenderers.clear();var t=0;this._materialRenderers.forEach((function(r,i){i.insertOrder=t++,e._sortedMaterialRenderers.push({material:i,materialRenderer:r})})),this._sortedMaterialRenderers.sort((function(e,t){var r=t.material.renderPriority-e.material.renderPriority;return 0!==r?r:e.material.insertOrder-t.material.insertOrder}))}},{key:"_processAddsRemoves",value:function(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(var e=0;e<this._changes.updates.length;){var t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),r}(f.a);Object(d.a)([Object(j.b)()],we.prototype,"rctx",void 0),Object(d.a)([Object(j.b)()],we.prototype,"materialRepository",void 0),Object(d.a)([Object(j.b)()],we.prototype,"updating",null),we=Object(d.a)([Object(_.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],we);var Te=function(){function e(){Object(c.a)(this,e),this.adds=new Set,this.removes=new Set,this.removed=new Set}return Object(u.a)(e,[{key:"empty",get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}},{key:"has",value:function(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}},{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}]),e}(),Se=r(900),Re=r(237),ke=r(239),Me=r(60),Ce=r(214),Ee=r(238),De=r(92),Pe=function(e){Object(l.a)(r,e);var t=Object(h.a)(r);function r(){return Object(c.a)(this,r),t.apply(this,arguments)}return Object(u.a)(r,[{key:"initializeProgram",value:function(e){var t=r.shader.get().build();return new Ee.a(e.rctx,t,Ce.a)}},{key:"initializePipeline",value:function(){return this.configuration.hasAlpha?Object(De.f)({blending:Object(De.g)(770,1,771,771),colorWrite:De.c}):Object(De.f)({colorWrite:De.c})}}]),r}(ke.a);Pe.shader=new Re.a(Se.a,(function(){return r.e(196).then(r.bind(null,1166))}));var Ie=function(e){Object(l.a)(r,e);var t=Object(h.a)(r);function r(){var e;return Object(c.a)(this,r),(e=t.apply(this,arguments)).hasAlpha=!1,e}return r}(Me.a);Object(d.a)([Object(Me.b)()],Ie.prototype,"hasAlpha",void 0);var Ae=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(T.e)();Object(c.a)(this,e),this.intensity=t},Le=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(T.e)(),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(T.g)(.57735,.57735,.57735);Object(c.a)(this,e),this.intensity=t,this.direction=r},ze=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(T.e)(),r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(T.g)(.57735,.57735,.57735),i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];Object(c.a)(this,e),this.intensity=t,this.direction=r,this.castShadows=i},He=function e(){Object(c.a)(this,e),this.r=[0],this.g=[0],this.b=[0]},Ne=r(11);function Ve(e,t,r){(r=r||e).length=e.length;for(var i=0;i<e.length;i++)r[i]=e[i]*t[i];return r}function Fe(e,t,r){(r=r||e).length=e.length;for(var i=0;i<e.length;i++)r[i]=e[i]*t;return r}function Ge(e,t,r){(r=r||e).length=e.length;for(var i=0;i<e.length;i++)r[i]=e[i]+t[i];return r}function Ue(e){return(e+1)*(e+1)}function We(e,t,r){var i=e[0],n=e[1],a=e[2],o=r||[];return o.length=Ue(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*i,o[2]=.4886025119*a,o[3]=.4886025119*n),t>=2&&(o[4]=1.09254843059*i*n,o[5]=1.09254843059*n*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*i*a,o[8]=.54627421529*(i*i-n*n)),o}function Be(e,t){var r,i,n=(r=t.r.length,Object(R.e)(Math.floor(Math.sqrt(r)-1),0,2)),a=Object(s.a)(e);try{for(a.s();!(i=a.n()).done;){var o=i.value;Object(Ne.s)(Ke,o.direction),We(Ke,n,Xe),Ve(Xe,$e),Fe(Xe,o.intensity[0],Je),Ge(t.r,Je),Fe(Xe,o.intensity[1],Je),Ge(t.g,Je),Fe(Xe,o.intensity[2],Je),Ge(t.b,Je)}}catch(c){a.e(c)}finally{a.f()}return t}function qe(e,t,r,i){(function(e,t){var r=Ue(e),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(var n=0;n<r;n++)i.r[n]=i.g[n]=i.b[n]=0})(t,i),Object(Ne.w)(r.intensity,0,0,0);var n=!1,a=Ze,o=Ye,c=Qe;a.length=0,o.length=0,c.length=0;var u,l=Object(s.a)(e);try{for(l.s();!(u=l.n()).done;){var h=u.value;h instanceof ze&&!n?(Object(Ne.k)(r.direction,h.direction),r.intensity[0]=h.intensity[0],r.intensity[1]=h.intensity[1],r.intensity[2]=h.intensity[2],r.castShadows=h.castShadows,n=!0):h instanceof ze||h instanceof Le?a.push(h):h instanceof Ae?o.push(h):h instanceof He&&c.push(h)}}catch(v){l.e(v)}finally{l.f()}Be(a,i),function(e,t){We(Ke,0,Xe);var r,i=Object(s.a)(e);try{for(i.s();!(r=i.n()).done;){var n=r.value;t.r[0]+=Xe[0]*$e[0]*n.intensity[0]*4*Math.PI,t.g[0]+=Xe[0]*$e[0]*n.intensity[1]*4*Math.PI,t.b[0]+=Xe[0]*$e[0]*n.intensity[2]*4*Math.PI}}catch(v){i.e(v)}finally{i.f()}}(o,i);var d,f=Object(s.a)(c);try{for(f.s();!(d=f.n()).done;){var p=d.value;Ge(i.r,p.r),Ge(i.g,p.g),Ge(i.b,p.b)}}catch(v){f.e(v)}finally{f.f()}}var Ze=[],Ye=[],Qe=[],Xe=[0],Je=[0],Ke=Object(T.e)(),$e=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],et=function(){function e(){Object(c.a)(this,e),this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:Object(T.e)(),ambient:{color:Object(T.e)(),intensity:1},diffuse:{color:Object(T.e)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new He,this._mainLight={intensity:Object(T.e)(),direction:Object(T.g)(1,0,0),castShadows:!1}}return Object(u.a)(e,[{key:"lightingMainDirection",get:function(){return this._mainLight.direction}},{key:"setLightDirectionUniform",value:function(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}},{key:"setUniforms",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",r),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);var i=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",i.r[0],i.r[1],i.r[2],i.r[3]),e.setUniform4f("lightingAmbientSH_G",i.g[0],i.g[1],i.g[2],i.g[3]),e.setUniform4f("lightingAmbientSH_B",i.b[0],i.b[1],i.b[2],i.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]),e.setUniform4f("lightingAmbientSH_R1",i.r[1],i.r[2],i.r[3],i.r[4]),e.setUniform4f("lightingAmbientSH_G1",i.g[1],i.g[2],i.g[3],i.g[4]),e.setUniform4f("lightingAmbientSH_B1",i.b[1],i.b[2],i.b[3],i.b[4]),e.setUniform4f("lightingAmbientSH_R2",i.r[5],i.r[6],i.r[7],i.r[8]),e.setUniform4f("lightingAmbientSH_G2",i.g[5],i.g[6],i.g[7],i.g[8]),e.setUniform4f("lightingAmbientSH_B2",i.b[5],i.b[6],i.b[7],i.b[8]))}},{key:"set",value:function(e){qe(e,this._shOrder,this._mainLight,this._sphericalHarmonics),Object(Ne.k)(this._oldSunlight.direction,this._mainLight.direction);var t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,Object(Ne.e)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),Object(Ne.k)(tt,this._oldSunlight.diffuse.color),Object(Ne.e)(tt,tt,this._ambientBoost*this.globalFactor),Object(Ne.f)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,tt)}},{key:"old",get:function(){return this._oldSunlight}}]),e}(),tt=Object(T.e)(),rt=function(){function e(t){Object(c.a)(this,e),this._rctx=t,this.cache=new Map}return Object(u.a)(e,[{key:"dispose",value:function(){this.cache.forEach((function(e){return e.texture=Object(g.f)(e.texture)})),this.cache.clear()}},{key:"acquire",value:function(e){var t=this;if(Object(g.j)(e))return null;var r=this.patternId(e),i=this.cache.get(r);if(i)return i.refCount++,i.bind;var n=this.patternToTextureData(e,2),a=n.length/2,o={refCount:1,texture:null,bind:function(e){return Object(g.j)(o.texture)&&(o.texture=new A.a(t._rctx,{width:n.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},n)),e.bindTexture(o.texture,"stipplePatternTexture"),a}};return this.cache.set(r,o),o.bind}},{key:"release",value:function(e){if(!Object(g.j)(e)){var t=this.patternId(e),r=this.cache.get(t);r&&(r.refCount--,0===r.refCount&&(Object(g.k)(r.texture)&&r.texture.dispose(),this.cache.delete(t)))}}},{key:"swap",value:function(e,t){var r=this.acquire(t);return this.release(e),r}},{key:"patternId",value:function(e){return e.join(",")}},{key:"patternToTextureData",value:function(e,t){var r,i=e.reduce((function(e,t){return e+t}))*t,n=new Uint8Array(i),a=!0,o=0,c=Object(s.a)(e);try{for(c.s();!(r=c.n()).done;){for(var u=r.value,l=0;l<u*t;l++)n[o++]=a?255:0;a=!a}}catch(h){c.e(h)}finally{c.f()}return n}}]),e}(),it=r(292),nt=v.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),at=function(e){Object(l.a)(r,e);var t=Object(h.a)(r);function r(e){var i;return Object(c.a)(this,r),(i=t.call(this,e))._overlays=null,i._overlayRenderTarget=null,i._hasHighlights=!1,i._rendersOccluded=!1,i._hasWater=!1,i._lighting=new et,i._handles=new p.a,i._layerRenderers=new Map,i._sortedLayerRenderersDirty=!1,i._sortedLayerRenderers=new m.a,i._geometries=new Map,i.globalUnitScale=1,i.longitudeCyclical=null,i}return Object(u.a)(r,[{key:"initialize",value:function(){var e=this,t=this.view._stage.renderView;this._rctx=t.renderingContext,this._renderContext=new $(this._rctx);var r=t.waterTextureRepository;this._stippleTextureRepository=new rt(t.renderingContext),this._shaderTechniqueRepository=new F({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._handles.add([Object(O.a)(r,"loadingState",(function(){return e.emitContentChanged()})),Object(O.a)(this,"spatialReference",(function(t){return e._localOrigins=new J.a(t)}))]),this._materialRepository=new Q(t.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=function(t){(t.renderOccluded&dt)>0!==e._rendersOccluded&&e.updateRendersOccluded(),e.emitContentChanged(),e.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new Ae(Object(T.g)(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:Object(X.a)(this._rctx),camera:ct,inverseViewport:Object(w.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(it.b.STAGE,this))}},{key:"dispose",value:function(){this._handles.destroy(),this._layerRenderers.forEach((function(e){return e.dispose()})),this._layerRenderers.clear(),this._debugTextureTechnique=Object(g.q)(this._debugTextureTechnique),this._debugPatternTexture=Object(g.f)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Object(g.f)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(g.f)(this._shaderTechniqueRepository),this._temporaryFBO=Object(g.f)(this._temporaryFBO),this._quadVAO=Object(g.f)(this._quadVAO),this._overlayRenderTarget=Object(g.f)(this._overlayRenderTarget)}},{key:"updating",get:function(){return this._sortedLayerRenderersDirty||Object(b.b)(this._layerRenderers,(function(e){return e.updating}))}},{key:"hasOverlays",get:function(){return Object(g.k)(this._overlays)&&Object(g.k)(this._overlayRenderTarget)}},{key:"gpuMemoryUsage",get:function(){return Object(g.k)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}},{key:"collectUnusedRenderTargetMemory",value:function(e){var t=!1;if(Object(g.k)(this._overlayRenderTarget)){var r,i=Object(s.a)(this._overlayRenderTarget.renderTargets);try{for(i.s();!(r=i.n()).done;){var n=r.value,a=this.overlays[0].validTargets[n.type]||!this.overlays[1].validTargets[n.type];t=this._overlayRenderTarget.validateUsageForTarget(a,n,e)||t}}catch(o){i.e(o)}finally{i.f()}}return t}},{key:"overlays",get:function(){return Object(g.t)(this._overlays,[])}},{key:"ensureDrapeTargets",value:function(e){Object(g.k)(this._overlays)&&this._overlays.forEach((function(t){t.hasTargetWithoutRasterImage=Object(y.a)(e,(function(e){return 1===e.drapeTargetType}))}))}},{key:"ensureDrapeSources",value:function(e){Object(g.k)(this._overlays)&&this._overlays.forEach((function(t){t.hasDrapedFeatureSource=Object(b.b)(e,(function(e,t){return 1===t.drapeSourceType})),t.hasDrapedRasterSource=Object(b.b)(e,(function(e,t){return 0===t.drapeSourceType}))}))}},{key:"ensureOverlays",value:function(e,t){Object(g.j)(this._overlays)&&(this._overlayRenderTarget=new H(this._rctx),this._overlays=[new E(0,this._overlayRenderTarget),new E(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}},{key:"disposeOverlays",value:function(){Object(g.k)(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},i=!1,n=Object(s.a)(this._layerRenderers);try{for(n.s();!(t=n.n()).done;){var a=Object(o.a)(t.value,2),c=a[0],u=a[1];if(e.done)break;r(c)&&(u.commitChanges()&&(i=!0,e.madeProgress()),u.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(c),this._handles.remove(c)))}}catch(l){n.e(l)}finally{n.f()}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),i=!0),i&&(Object(g.k)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}},{key:"processSyncLayers",value:function(){this.runTask(it.c,(function(e){return 1===e.updatePolicy}))}},{key:"addGeometries",value:function(e,t,r){var i,n=Object(s.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value;Object(g.j)(a.origin)&&(a.origin=this._localOrigins.getOrigin(a.boundingSphere)),this._geometries.set(a.id,a)}}catch(o){n.e(o)}finally{n.f()}this.ensureLayerRenderer(t).add(e),2===r&&this.notifyGraphicGeometryChanged(e,t)}},{key:"removeGeometries",value:function(e,t,r){var i,n=Object(s.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value;this._geometries.delete(Object(g.s)(a.id))}}catch(c){n.e(c)}finally{n.f()}var o=this._layerRenderers.get(t);o&&(o.remove(e),2===r&&this.notifyGraphicGeometryChanged(e,t))}},{key:"updateGeometries",value:function(e,t,r){var i=this._layerRenderers.get(t);if(i)switch(i.modify(e,r),r){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else nt.warn("Attempted to update geometry for nonexistent layer")}},{key:"notifyGraphicGeometryChanged",value:function(e,t){if(!Object(g.j)(t.notifyGraphicGeometryChanged)){var r,i,n=Object(s.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value.graphicUid;Object(g.k)(a)&&a!==r&&(t.notifyGraphicGeometryChanged(a),r=a)}}catch(o){n.e(o)}finally{n.f()}}}},{key:"notifyGraphicVisibilityChanged",value:function(e,t){if(!Object(g.j)(t.notifyGraphicVisibilityChanged)){var r,i,n=Object(s.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value.graphicUid;Object(g.k)(a)&&a!==r&&(t.notifyGraphicVisibilityChanged(a),r=a)}}catch(o){n.e(o)}finally{n.f()}}}},{key:"updateHighlights",value:function(e,t){var r=this._layerRenderers.get(t);r?r.modify(e,8):nt.warn("Attempted to update highlights for nonexistent layer")}},{key:"isEmpty",value:function(){return 0===this._geometries.size&&!S.a.OVERLAY_DRAW_DEBUG_TEXTURE}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"updateLogic",value:function(e){var t=!1;return this._layerRenderers.forEach((function(r){r.updateLogic(e)&&(t=!0)})),t}},{key:"updateLayerOrder",value:function(){this._sortedLayerRenderersDirty=!0}},{key:"drawTarget",value:function(e,t,r){var i=this,n=e.canvasGeometries;if(0===n.numViews)return!1;var a=e.pixelRatio*r;this._screenToWorldRatio=a*Math.abs(n.extents[0][2]-n.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);var o=t.renderPass;if(this.isEmpty()||5===o&&!this.hasHighlights||3===o&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;var s=t.fbo,c=2*e.resolution,u=e.resolution,l=1===t.type?2:4===t.type?1:0;if(!s.isValid())return!1;s.resize(c,u);var h=this._rctx;if(ct.pixelRatio=a||1,this._renderContext.pass=o,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),s.bind(h),0===e.index&&(h.setClearColor(0,0,0,0),h.clearSafe(16384)),1===l&&(this._renderContext.renderOccludedMask=dt),S.a.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==l)for(var d=0;d<n.numViews;d++)this.setViewParameters(n.extents[d],e,ct),this.drawDebugTexture(e.resolution,st[e.index%st.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((function(t){var r=t.layerView,a=t.renderer;if(2!==l||!Object(g.k)(r)||0!==r.drapeSourceType){var d=Object(g.k)(r)&&Object(g.k)(r.fullOpacity)&&r.fullOpacity<1&&0===o;d&&(i.bindTemporaryFramebuffer(i._rctx,c,u),h.clearSafe(16384));for(var f=0;f<n.numViews;f++)i.setViewParameters(n.extents[f],e,ct),a.render(i._renderContext,i._bindParameters);d&&Object(g.k)(i._temporaryFBO)&&(s.bind(h),i.view._stage.renderView.compositingHelper.composite(i._temporaryFBO.getTexture(),2,Object(g.s)(Object(g.s)(r).fullOpacity),3,e.index))}})),h.bindFramebuffer(null),s.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}},{key:"bindTemporaryFramebuffer",value:function(e,t,r){Object(g.j)(this._temporaryFBO)&&(this._temporaryFBO=new z(e,!1)),this._temporaryFBO.resize(t,r),this._temporaryFBO.bind(e)}},{key:"reloadShaders",value:function(){var e=Object(a.a)(n.a.mark((function e(){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._shaderTechniqueRepository.hotReload();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"intersect",value:function(e,t,r){var i=this,n=0;this._geometries.forEach((function(a){if(!r||r(a)){i.intersectRenderGeometry(a,t,0,e,n);var o=i.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&i.intersectRenderGeometry(a,t,o.range,e,n),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&i.intersectRenderGeometry(a,t,-o.range,e,n)),n++}}))}},{key:"intersectRenderGeometry",value:function(e,t,r,i,n){var a=this;if(e.instanceParameters.visible){var o=0;Object(g.k)(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),ut[0]=t[0]-r,ut[1]=t[1]-o,ut[2]=1,lt[0]=t[0]-r,lt[1]=t[1]-o,lt[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,ut,lt,(function(t,r,o){a.addIntersectionResult(o,e.material.renderPriority,n,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}}},{key:"addIntersectionResult",value:function(e,t,r,i,n,a){var o={type:"external",metadata:{layerUid:n,graphicUid:a}},s=function(n){n.set(o,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,t,null,null,e,r),n.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&s(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&s(i.results.max),2===i.options.store){var c=new K.a(i.ray);s(c),i.results.all.push(c)}}},{key:"stopAnimationsAtTime",value:function(e){this._sortedLayerRenderers.forAll((function(t){return t.renderer.stopAnimationsAtTime(e)}))}},{key:"ensureLayerRenderer",value:function(e){var t=this,r=this._layerRenderers.get(e);return r||(r=new we({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,r),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(function(){return t.emitContentChanged()})),e),this._handles.add(Object(O.a)(r,"updating",(function(){return t.notifyChange("updating")})),e)),r}},{key:"updateSortedLayerRenderers",value:function(){var e=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var t=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((function(r){var i=r,n=e._layerRenderers.get(i);n&&(e._sortedLayerRenderers.push(new ot(i,n)),t.delete(n))})),t.forEach((function(t){return e._sortedLayerRenderers.push(new ot(null,t))}))}}},{key:"setViewParameters",value:function(e,t,r){r.viewport=t.viewport,Object(x.o)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),Object(x.i)(r.viewMatrix),Object(x.t)(r.viewMatrix,r.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=r,this._bindParameters.camera=r,this._bindParameters.inverseViewport[0]=1/r.fullViewport[2],this._bindParameters.inverseViewport[1]=1/r.fullViewport[3]}},{key:"emitContentChanged",value:function(){this.onContentChanged&&this.onContentChanged()}},{key:"updateHasWater",value:function(){var e=Object(b.b)(this._layerRenderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e))}},{key:"updateHasHighlights",value:function(){var e=Object(b.b)(this._layerRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}},{key:"updateRendersOccluded",value:function(){var e=Object(b.b)(this._layerRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}},{key:"drawDebugTexture",value:function(e,t){var r=this._rctx;this.ensureDebugPatternResources(e,e);var i=this._debugTextureTechnique.program;r.useProgram(i),r.setPipelineState(this._debugTextureTechnique.pipeline),i.setUniform4f("color",t[0],t[1],t[2],1),i.bindTexture(this._debugPatternTexture,"tex"),r.bindVAO(this._quadVAO),r.drawArrays(5,0,Object(be.f)(this._quadVAO,"geometry"))}},{key:"ensureDebugPatternResources",value:function(e,t){if(!this._debugPatternTexture){for(var r=new Uint8Array(e*t*4),i=0,n=0;n<t;n++)for(var a=0;a<e;a++){var o=Math.floor(a/10),s=Math.floor(n/10);o<2||s<2||10*o>e-20||10*s>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&o&&1&s?1&a^1&n?0:255:1&o^1&s?0:128)}this._debugPatternTexture=new A.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},r);var c=new Ie;c.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(Pe,c),this._quadVAO=Object(X.b)(this._rctx)}}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),r}(Object(G.b)(f.a));Object(d.a)([Object(G.c)()],at.prototype,"_shaderTechniqueRepository",void 0),Object(d.a)([Object(G.c)()],at.prototype,"_stippleTextureRepository",void 0),Object(d.a)([Object(j.b)({constructOnly:!0})],at.prototype,"view",void 0),Object(d.a)([Object(j.b)()],at.prototype,"globalUnitScale",void 0),Object(d.a)([Object(j.b)()],at.prototype,"spatialReference",void 0),Object(d.a)([Object(j.b)({type:Boolean,readOnly:!0})],at.prototype,"updating",null),at=Object(d.a)([Object(_.a)("esri.views.3d.terrain.OverlayRenderer")],at);var ot=function e(t,r){Object(c.a)(this,e),this.layerView=t,this.renderer=r},st=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],ct=new U.a;ct.near=1,ct.far=1e4,ct.relativeElevation=null;var ut=Object(T.e)(),lt=Object(T.e)(),ht=-2,dt=4},936:function(e,t,r){"use strict";r.d(t,"a",(function(){return G}));var i=r(9),n=r(2),a=r(3),o=r(5),s=r(6),c=r(13),u=r(4),l=r(32),h=r(26),d=r(11),f=r(22),p=r(86),v=r(59),b=r(100),g=r(217),m=r(339),y=r(270),O=r(75),j=r(294),_=r(484),x=r(191),w=r(218),T=r(46),S=r(45),R=r(0),k=r(201),M=r(236),C=r(216),E=r(237),D=r(239),P=r(60),I=r(214),A=r(238),L=r(168),z=r(905),H=r(92),N=function(e){Object(o.a)(r,e);var t=Object(s.a)(r);function r(e,i,a){var o;return Object(n.a)(this,r),(o=t.call(this,e,i,a)).stipplePattern=null,o.stippleTextureBind=null,o.stippleTextureRepository=e.stippleTextureRepository,o}return Object(a.a)(r,[{key:"initializeProgram",value:function(e){var t=r.shader.get(),i=this.configuration,n=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:i.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:i.stippleIntegerRepeatsEnabled});return new A.a(e.rctx,n,I.a)}},{key:"dispose",value:function(){Object(T.a)(Object(S.a)(r.prototype),"dispose",this).call(this),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}},{key:"bindPass",value:function(e,t){if(Object(C.c)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){var r=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.configuration.stippleEnabled){var i=Object(u.k)(this.stippleTextureBind)?this.stippleTextureBind(this.program)*t.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){var n=Object(u.s)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",n[0],n[1],n[2],n.length>3?n[3]:1)}4===this.configuration.output&&Object(M.b)(this.program,t)}},{key:"bindDraw",value:function(e){Object(C.d)(this.program,e),Object(k.c)(this.program,this.configuration,e),this.program.rebindTextures()}},{key:"initializePipeline",value:function(){var e=this.configuration,t=Object(H.g)(770,1,771,771),r=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return Object(H.f)({blending:r,depthTest:L.b,depthWrite:i,colorWrite:H.c,stencilWrite:e.sceneHasOcludees?L.h:null,stencilTest:e.sceneHasOcludees?t?L.d:L.c:null})};return 0===e.output?(this._occludeePipelineState=r(!0,e.transparent||e.stippleEnabled?t:null,H.d),r(!1,e.transparent||e.stippleEnabled?t:null,H.d)):r(!1)}},{key:"primitiveType",get:function(){return 1}},{key:"getPipelineState",value:function(e){return e?this._occludeePipelineState:this.pipeline}}]),r}(D.a);N.shader=new E.a(z.a,(function(){return r.e(204).then(r.bind(null,1170))}));var V=function(e){Object(o.a)(r,e);var t=Object(s.a)(r);function r(){var e;return Object(n.a)(this,r),(e=t.apply(this,arguments)).output=0,e.slicePlaneEnabled=!1,e.vertexColors=!1,e.transparent=!1,e.stippleEnabled=!1,e.stippleOffColorEnabled=!1,e.stippleIntegerRepeatsEnabled=!1,e.sceneHasOcludees=!1,e}return r}(P.a);Object(R.a)([Object(P.b)({count:8})],V.prototype,"output",void 0),Object(R.a)([Object(P.b)()],V.prototype,"slicePlaneEnabled",void 0),Object(R.a)([Object(P.b)()],V.prototype,"vertexColors",void 0),Object(R.a)([Object(P.b)()],V.prototype,"transparent",void 0),Object(R.a)([Object(P.b)()],V.prototype,"stippleEnabled",void 0),Object(R.a)([Object(P.b)()],V.prototype,"stippleOffColorEnabled",void 0),Object(R.a)([Object(P.b)()],V.prototype,"stippleIntegerRepeatsEnabled",void 0),Object(R.a)([Object(P.b)()],V.prototype,"sceneHasOcludees",void 0);var F=c.a.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),G=function(e){Object(o.a)(r,e);var t=Object(s.a)(r);function r(e){var i;return Object(n.a)(this,r),(i=t.call(this,e,B)).techniqueConfig=new V,i}return Object(a.a)(r,[{key:"getTechniqueConfig",value:function(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;var t=Object(u.k)(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&Object(u.k)(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}},{key:"getPassParameters",value:function(){return this.params}},{key:"intersect",value:function(e,t,r,i,n,a,o,s,c){c?Object(x.e)(e,i,a,1,o):this.intersectLineGeometry(e,t,r,i,o)}},{key:"intersectLineGeometry",value:function(e,t,r,i,n){if(i.options.selectionMode&&!Object(w.e)(t))if(Object(O.g)(r)){var a=e.vertexAttributes.get("position").data,o=i.camera,s=re;Object(h.c)(s,i.point);Object(d.w)(ie[0],s[0]-2,s[1]+2,0),Object(d.w)(ie[1],s[0]+2,s[1]+2,0),Object(d.w)(ie[2],s[0]+2,s[1]-2,0),Object(d.w)(ie[3],s[0]-2,s[1]-2,0);for(var c=0;c<4;c++)if(!o.unprojectFromRenderScreen(ie[c],ne[c]))return;Object(v.f)(o.eye,ne[0],ne[1],ae),Object(v.f)(o.eye,ne[1],ne[2],oe),Object(v.f)(o.eye,ne[2],ne[3],se),Object(v.f)(o.eye,ne[3],ne[0],ce);for(var u=Number.MAX_VALUE,l=0;l<a.length-5;l+=3)if(q[0]=a[l]+r[12],q[1]=a[l+1]+r[13],q[2]=a[l+2]+r[14],Z[0]=a[l+3]+r[12],Z[1]=a[l+4]+r[13],Z[2]=a[l+5]+r[14],!(Object(v.u)(ae,q)<0&&Object(v.u)(ae,Z)<0||Object(v.u)(oe,q)<0&&Object(v.u)(oe,Z)<0||Object(v.u)(se,q)<0&&Object(v.u)(se,Z)<0||Object(v.u)(ce,q)<0&&Object(v.u)(ce,Z)<0)){if(o.projectToRenderScreen(q,X),o.projectToRenderScreen(Z,J),X[2]<0&&J[2]>0){Object(d.j)(Y,q,Z);var f=o.frustum,b=-Object(v.u)(f[4],q)/Object(d.h)(Y,Object(v.r)(f[4]));Object(d.e)(Y,Y,b),Object(d.f)(q,q,Y),o.projectToRenderScreen(q,X)}else if(X[2]>0&&J[2]<0){Object(d.j)(Y,Z,q);var g=o.frustum,m=-Object(v.u)(g[4],Z)/Object(d.h)(Y,Object(v.r)(g[4]));Object(d.e)(Y,Y,m),Object(d.f)(Z,Z,Y),o.projectToRenderScreen(Z,J)}else if(X[2]<0&&J[2]<0)continue;X[2]=0,J[2]=0;var y=Object(p.e)(Object(p.f)(X,J,ee),s);y<u&&(u=y,Object(d.k)(K,q),Object(d.k)($,Z))}var j=i.rayBeginPoint,_=i.rayEndPoint;if(u<4){var x=Number.MAX_VALUE;if(Object(p.a)(Object(p.f)(K,$,ee),Object(p.f)(j,_,te),Q)){Object(d.j)(Q,Q,j);var T=Object(d.p)(Q);Object(d.e)(Q,Q,1/T),x=T/Object(d.m)(j,_)}n(x,Q)}}else F.error("intersection assumes a translation-only matrix")}},{key:"computeAttachmentOrigin",value:function(e,t){var r=e.vertexAttributes;if(!r)return!1;var i=r.get("position");return Object(g.a)(i,null,!1,t)}},{key:"createBufferWriter",value:function(){var e=this.params.vertexColors?_.b:_.c;return Object(u.j)(this.params.stipplePattern)?new _.a(e):new W(e.clone().vec3f("auxpos1"))}},{key:"getGLMaterial",value:function(e){return 0===e.output||4===e.output?new U(e):void 0}}]),r}(y.a),U=function(e){Object(o.a)(r,e);var t=Object(s.a)(r);function r(e){var i;return Object(n.a)(this,r),(i=t.call(this,e)).updateParameters(),i}return Object(a.a)(r,[{key:"updateParameters",value:function(){this._technique=this._techniqueRep.releaseAndAcquire(N,this._material.getTechniqueConfig(this._output),this._technique)}},{key:"beginSlot",value:function(e){return 3===e}},{key:"_updateOccludeeState",value:function(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())}},{key:"ensureParameters",value:function(e){0===this._output&&this._updateOccludeeState(e)}},{key:"bind",value:function(e){this._technique.bindPass(this._material.getPassParameters(),e)}},{key:"getPipelineState",value:function(e,t){return this._technique.getPipelineState(t)}}]),r}(m.a),W=function(){function e(t){Object(n.a)(this,e),this.vertexBufferLayout=t}return Object(a.a)(e,[{key:"allocate",value:function(e){return this.vertexBufferLayout.createBuffer(e)}},{key:"elementCount",value:function(e){return e.indices.get("position").length}},{key:"write",value:function(e,t,r,i){Object(j.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,i),this.writeAuxpos1(e,t,r,i)}},{key:"writeAuxpos1",value:function(e,t,r,i){var n=r.getField("auxpos1",b.u),a=t.indices.get("position"),o=t.vertexAttributes.get("position").data,s=e.transformation,c=n.typedBufferStride,u=n.typedBuffer;i*=c;for(var l=0;l<a.length;l+=2)for(var h=3*a[l],d=o[h],f=o[h+1],p=o[h+2],v=s[0]*d+s[4]*f+s[8]*p+s[12],g=s[1]*d+s[5]*f+s[9]*p+s[13],m=s[2]*d+s[6]*f+s[10]*p+s[14],y=0;y<2;++y)u[i]=v,u[i+1]=g,u[i+2]=m,i+=c}}]),e}(),B=Object(i.a)({color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1},y.b),q=Object(f.e)(),Z=Object(f.e)(),Y=Object(f.e)(),Q=Object(f.e)(),X=Object(l.d)(),J=Object(l.d)(),K=Object(f.e)(),$=Object(f.e)(),ee=Object(p.d)(),te=Object(p.d)(),re=Object(f.e)(),ie=[Object(l.d)(),Object(l.d)(),Object(l.d)(),Object(l.d)()],ne=[Object(f.e)(),Object(f.e)(),Object(f.e)(),Object(f.e)()],ae=Object(v.d)(),oe=Object(v.d)(),se=Object(v.d)(),ce=Object(v.d)()},948:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var i=r(2),n=r(22),a=function e(t,r){Object(i.a)(this,e),this.vec3=t,this.id=r};function o(e,t,r,i){return new a(Object(n.g)(e,t,r),i)}},949:function(e,t,r){"use strict";r.d(t,"a",(function(){return g}));var i=r(28),n=r(2),a=r(3),o=r(4),s=r(104),c=r(11),u=r(22),l=r(108),h=r(158),d=r(948),f=r(414),p=r(425),v=r(342),b=0,g=function(){function e(t){Object(n.a)(this,e),this._originSR=t,this.ROOT_ORIGIN_ID="rg_root_"+b++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}return Object(a.a)(e,[{key:"getOrigin",value:function(e){var t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if(Object(o.k)(m))return this._origins.set(this.ROOT_ORIGIN_ID,Object(d.a)(m[0],m[1],m[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e);var r=Object(d.a)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,r),r}var n=this._gridSize,a=Math.round(e[0]/n),s=Math.round(e[1]/n),u=Math.round(e[2]/n),l="".concat("rg_").concat(a,"/").concat(s,"/").concat(u),h=this._origins.get(l),f=.5*n;if(Object(c.j)(y,e,t.vec3),y[0]=Math.abs(y[0]),y[1]=Math.abs(y[1]),y[2]=Math.abs(y[2]),y[0]<f&&y[1]<f&&y[2]<f){if(h){var p=Math.max.apply(Math,Object(i.a)(y));if(Object(c.j)(y,e,h.vec3),y[0]=Math.abs(y[0]),y[1]=Math.abs(y[1]),y[2]=Math.abs(y[2]),Math.max.apply(Math,Object(i.a)(y))<p)return h}return t}return h||(h=Object(d.a)(a*n,s*n,u*n,l),this._origins.set(l,h)),h}},{key:"_drawOriginBox",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[1,1,0,1],r=window.view,i=r._stage,n=t.toString();if(!this._objects.has(n)){this._material=new v.a({width:2,color:t}),i.add(this._material);var a=new p.a({isPickable:!1}),o=new f.a({castShadow:!1});i.add(o),a.add(o),i.add(a),this._objects.set(n,o)}for(var c=this._objects.get(n),u=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],d=u.length,b=new Array(3*d),g=new Uint16Array(2*(d-1)),m=.5*this._gridSize,y=0;y<d;y++)b[3*y+0]=e[0]+(1&u[y]?m:-m),b[3*y+1]=e[1]+(2&u[y]?m:-m),b[3*y+2]=e[2]+(4&u[y]?m:-m),y>0&&(g[2*y+0]=y-1,g[2*y+1]=y);Object(l.m)(b,this._originSR,0,b,r.renderSpatialReference,0,d);var O=new h.a([["position",{size:3,data:b,exclusive:!0}]],[["position",g]],2);i.add(O),c.addGeometry(O,this._material,s.a)}},{key:"test",get:function(){var e=this;return{get gridSize(){return e._gridSize},set gridSize(t){e._gridSize=t}}}}]),e}(),m=null;var y=Object(u.e)()},950:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var i=r(2),n=r(3),a=r(5),o=r(6),s=r(339),c=r(951),u=function(e){Object(a.a)(r,e);var t=Object(o.a)(r);function r(e){var n;return Object(i.a)(this,r),(n=t.call(this,e)).updateParameters(),n}return Object(n.a)(r,[{key:"updateParameters",value:function(e){this._technique=this._techniqueRep.releaseAndAcquire(c.a,this._material.getTechniqueConfig(this._output,e),this._technique)}},{key:"beginSlot",value:function(e){if(2===this._output)return 22===e;if(5===this._output)return null==e;if(4===this._output)return 3===e;var t=3;return this._material.params.transparent&&(t=this._material.params.writeDepth?5:8),e===t}},{key:"setElapsedTimeUniform",value:function(e){var t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.params.animationSpeed)}},{key:"_updateShadowState",value:function(e){e.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}},{key:"_updateSSRState",value:function(e){e.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:e.ssrEnabled})}},{key:"ensureResources",value:function(e){return this._technique.ensureResource(e)}},{key:"ensureParameters",value:function(e){0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}},{key:"bind",value:function(e){this._technique.bindPass(this._material.params,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program)}}]),r}(s.a)},951:function(e,t,r){"use strict";r.d(t,"a",(function(){return x})),r.d(t,"b",(function(){return w}));var i=r(2),n=r(3),a=r(5),o=r(6),s=r(0),c=r(201),u=r(236),l=r(231),h=r(744),d=r(1007),f=r(898),p=r(216),v=r(237),b=r(239),g=r(60),m=r(214),y=r(157),O=r(238),j=r(899),_=r(92),x=function(e){Object(a.a)(r,e);var t=Object(o.a)(r);function r(e,n,a){var o;return Object(i.a)(this,r),(o=t.call(this,e,n,a))._textureRepository=e.waterTextureRepository,o}return Object(n.a)(r,[{key:"initializeProgram",value:function(e){var t=r.shader.get(),i=this.configuration,n=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new O.a(e.rctx,n,m.a)}},{key:"ensureResource",value:function(e){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(e),this._textureRepository.ready?2:1}},{key:"bindPass",value:function(e,t){Object(p.c)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(l.a)(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),Object(d.b)(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||(Object(f.b)(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&Object(u.b)(this.program,t)}},{key:"bindDraw",value:function(e){Object(p.d)(this.program,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||Object(p.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Object(h.b)(this.program,e),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Object(c.c)(this.program,this.configuration,e)}},{key:"setPipelineState",value:function(e){var t=this.configuration,r=3===e,i=2===e;return Object(_.f)({blending:2!==t.output&&4!==t.output&&t.transparent?r?y.f:Object(y.a)(e):null,depthTest:{func:Object(y.b)(e)},depthWrite:r?t.writeDepth&&_.d:Object(y.c)(e),colorWrite:_.c,polygonOffset:r||i?null:Object(y.g)(t.enableOffset)})}},{key:"initializePipeline",value:function(){return this.setPipelineState(this.configuration.transparencyPassType)}}]),r}(b.a);x.shader=new v.a(j.a,(function(){return r.e(210).then(r.bind(null,1011))}));var w=function(e){Object(a.a)(r,e);var t=Object(o.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).output=0,e.receiveShadows=!1,e.slicePlaneEnabled=!1,e.transparent=!1,e.enableOffset=!0,e.writeDepth=!1,e.useSSR=!1,e.isDraped=!1,e.transparencyPassType=3,e.multipassTerrainEnabled=!1,e.cullAboveGround=!1,e}return r}(g.a);Object(s.a)([Object(g.b)({count:8})],w.prototype,"output",void 0),Object(s.a)([Object(g.b)()],w.prototype,"receiveShadows",void 0),Object(s.a)([Object(g.b)()],w.prototype,"slicePlaneEnabled",void 0),Object(s.a)([Object(g.b)()],w.prototype,"transparent",void 0),Object(s.a)([Object(g.b)()],w.prototype,"enableOffset",void 0),Object(s.a)([Object(g.b)()],w.prototype,"writeDepth",void 0),Object(s.a)([Object(g.b)()],w.prototype,"useSSR",void 0),Object(s.a)([Object(g.b)()],w.prototype,"isDraped",void 0),Object(s.a)([Object(g.b)({count:4})],w.prototype,"transparencyPassType",void 0),Object(s.a)([Object(g.b)()],w.prototype,"multipassTerrainEnabled",void 0),Object(s.a)([Object(g.b)()],w.prototype,"cullAboveGround",void 0)},952:function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return s}));var i,n,a=r(29),o=r(27);function s(e){e.fragment.code.add(Object(o.a)(i||(i=Object(a.a)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function c(e){e.fragment.code.add(Object(o.a)(n||(n=Object(a.a)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}}}]);
//# sourceMappingURL=7.7159c1e8.chunk.js.map